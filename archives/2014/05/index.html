
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2014/5 | 左手代码 右手年华</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一个尘世迷途小码农的程序与人生">
<meta property="og:type" content="website">
<meta property="og:title" content="左手代码 右手年华">
<meta property="og:url" content="http://www.harrycode.com/archives/2014/05/index.html">
<meta property="og:site_name" content="左手代码 右手年华">
<meta property="og:description" content="一个尘世迷途小码农的程序与人生">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="左手代码 右手年华">
<meta name="twitter:description" content="一个尘世迷途小码农的程序与人生">
  
    <link rel="alternative" href="/atom.xml" title="左手代码 右手年华" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">左手代码 右手年华</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个尘世迷途小码农的程序与人生</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="www.harrycode.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-nginx-monitoring-tool-ngxtop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/20/nginx-monitoring-tool-ngxtop/" class="article-date">
  <time datetime="2014-05-20T04:01:00.000Z" itemprop="datePublished">2014-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/20/nginx-monitoring-tool-ngxtop/">Nginx监控利器 Ngxtop</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简介">简介</h1><p>Nginx 作为新一代的WebServer + ProxyServer， 以其优秀的并发能力，已被广泛接受。使用之广，直逼界内前辈 Apache。今天我们介绍一款Nginx的监控工具 <a href="https://github.com/lebinh/ngxtop#rd" target="_blank" rel="external">Ngxtop</a>，这款工具基于AccessLog的解析，为我们提供非常友好的统计方式，统计各个页面的request_path, remote_addr, status等，并基于字段order/group，监控起来自然是比awk这些工具要方便许多。<strong>附官方Demo：</strong></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ ngxtop</span><br><span class="line">running for <span class="number">411</span> seconds, <span class="number">64332</span> records processed: <span class="number">156.60</span> req/sec</span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line"><span class="string">|   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</span></span><br><span class="line"><span class="string">|---------+------------------+-------+-------+-------+-------|</span></span><br><span class="line"><span class="string">|   64332 |         2775.251 | 61262 |  2994 |    71 |     5 |</span></span><br><span class="line"></span><br><span class="line">Detailed:</span><br><span class="line"><span class="string">| request_path                             |   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</span></span><br><span class="line"><span class="string">|------------------------------------------+---------+------------------+-------+-------+-------+-------|</span></span><br><span class="line"><span class="string">| /abc/xyz/xxxx                            |   20946 |          434.693 | 20935 |     0 |    11 |     0 |</span></span><br><span class="line"><span class="string">| /xxxxx.json                              |    5633 |         1483.723 |  5633 |     0 |     0 |     0 |</span></span><br><span class="line"><span class="string">| /xxxxx/xxx/xxxxxxxxxxxxx                 |    3629 |         6835.499 |  3626 |     0 |     3 |     0 |</span></span><br><span class="line"><span class="string">| /xxxxx/xxx/xxxxxxxx                      |    3627 |        15971.885 |  3623 |     0 |     4 |     0 |</span></span><br><span class="line"><span class="string">| /xxxxx/xxx/xxxxxxx                       |    3624 |         7830.236 |  3621 |     0 |     3 |     0 |</span></span><br><span class="line"><span class="string">| /static/js/minified/utils.min.js         |    3031 |         1781.155 |  2104 |   927 |     0 |     0 |</span></span><br><span class="line"><span class="string">| /static/js/minified/xxxxxxx.min.v1.js    |    2889 |         2210.235 |  2068 |   821 |     0 |     0 |</span></span><br><span class="line"><span class="string">| /static/tracking/js/xxxxxxxx.js          |    2594 |         1325.681 |  1927 |   667 |     0 |     0 |</span></span><br><span class="line"><span class="string">| /xxxxx/xxx.html                          |    2521 |          573.597 |  2520 |     0 |     1 |     0 |</span></span><br><span class="line"><span class="string">| /xxxxx/xxxx.json                         |    1840 |          800.542 |  1839 |     0 |     1 |     0 |</span></span><br></pre></td></tr></table></figure>
<h1 id="安装">安装</h1><p>Ngxtop 是基于Python编写的，依赖Python，通过pip即可安装。一般服务器都会遇装Python，只是版本高低各有不同。安装Python的文章可以随手找到，不再赘述。</p>
<h2 id="pip">pip</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget --<span class="keyword">no</span>-check-certificate http<span class="variable">s:</span>//bootstrap.pypa.io/<span class="built_in">get</span>-pip.<span class="keyword">py</span></span><br><span class="line"><span class="keyword">python</span> <span class="built_in">get</span>-pip.<span class="keyword">py</span></span><br></pre></td></tr></table></figure>
<h2 id="Ngxtop">Ngxtop</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">beta-<span class="number">01</span>#  pip install ngxtop</span><br><span class="line"></span><br><span class="line">Downloading/unpacking ngxtop</span><br><span class="line">  Downloading ngxtop-<span class="number">0.0</span>.2-py2.py3-none-any.whl</span><br><span class="line">Downloading/unpacking pyparsing (from ngxtop)</span><br><span class="line">  Downloading pyparsing-<span class="number">2.0</span>.2.tar.gz (<span class="number">1.1</span>MB): <span class="number">1.1</span>MB downloaded</span><br><span class="line">  Running setup.py (<span class="string">path:</span><span class="regexp">/tmp/</span>pip_build_root<span class="regexp">/pyparsing/</span>setup.py) egg_info <span class="keyword">for</span> <span class="keyword">package</span> pyparsing</span><br><span class="line">Downloading/unpacking docopt (from ngxtop)</span><br><span class="line">  Downloading docopt-<span class="number">0.6</span>.1.tar.gz</span><br><span class="line">  Running setup.py (<span class="string">path:</span><span class="regexp">/tmp/</span>pip_build_root<span class="regexp">/docopt/</span>setup.py) egg_info <span class="keyword">for</span> <span class="keyword">package</span> docopt</span><br><span class="line">Downloading/unpacking tabulate (from ngxtop)</span><br><span class="line">  Downloading tabulate-<span class="number">0.7</span>.2.tar.gz</span><br><span class="line">  Running setup.py (<span class="string">path:</span><span class="regexp">/tmp/</span>pip_build_root<span class="regexp">/tabulate/</span>setup.py) egg_info <span class="keyword">for</span> <span class="keyword">package</span> tabulate</span><br><span class="line">Installing collected <span class="string">packages:</span> ngxtop, pyparsing, docopt, tabulate</span><br><span class="line">  Running setup.py install <span class="keyword">for</span> pyparsing</span><br><span class="line">  Running setup.py install <span class="keyword">for</span> docopt</span><br><span class="line">  Running setup.py install <span class="keyword">for</span> tabulate</span><br><span class="line">Successfully installed ngxtop pyparsing docopt tabulate</span><br><span class="line">Cleaning up...</span><br></pre></td></tr></table></figure>
<h1 id="使用">使用</h1><p>老规矩，看看help</p>
<p>Options:<br><code>-l &lt;file&gt;, --access-log &lt;file&gt;  access log file to parse.</code>  #指定access log<br><code>-f &lt;format&gt;, --log-format &lt;format&gt;  log format as specify in log_format directive. [default: combined]</code> #指定 log format<br><code>--no-follow  ngxtop default behavior is to ignore current lines in log and only watch for new lines as they are written to the access log. Use this flag to tell ngxtop to process the current content of the access log instead.</code> #ngxtop默认会对accesslog的新增行进行统计， 通过这个选项可以让ngxtop统计旧log<br><code>-t &lt;seconds&gt;, --interval &lt;seconds&gt;  report interval when running in follow mode [default: 2.0]</code><br><code>-g &lt;var&gt;, --group-by &lt;var&gt;  group by variable [default: request_path]</code> # 基于字段分组<br><code>-w &lt;var&gt;, --having &lt;expr&gt;  having clause [default: 1]</code> # 分组之后再筛选<br><code>-o &lt;var&gt;, --order-by &lt;var&gt;  order of output for default query [default: count]</code> # 排序字段<br><code>-n &lt;number&gt;, --limit &lt;number&gt;  limit the number of records included in report for top command [default: 10]</code> #默认显示前多少条<br><code>-a &lt;exp&gt; ..., --a &lt;exp&gt; ...  add exp (must be aggregation exp: sum, avg, min, max, etc.) into output</code> # 对输出字段做附加条件 sum/avg/min/max 可选</p>
<p><code>-v, --verbose  more verbose output</code><br><code>-d, --debug  print every line and parsed record</code><br><code>-h, --help  print this help message.</code><br><code>--version  print version information.</code></p>
<p>Advanced / experimental options:<br><code>-c &lt;file&gt;, --config &lt;file&gt;  allow ngxtop to parse nginx config file for log format and location.</code> # 指定nginx config文件，ngxtop 会自动解析配置文件，分析出access log的位置以及格式<br><code>-i &lt;filter-expression&gt;, --filter &lt;filter-expression&gt;  filter in, records satisfied given expression are processed.</code><br><code>-p &lt;filter-expression&gt;, --pre-filter &lt;filter-expression&gt; in-filter expression to check in pre-parsing phase.</code></p>
<p>一些demo<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Examples:</span><br><span class="line">    <span class="keyword">All</span> examples read nginx config <span class="keyword">file</span> <span class="keyword">for</span> <span class="keyword">access</span> log location <span class="keyword">and</span> format.</span><br><span class="line">    <span class="keyword">If</span> you want <span class="keyword">to</span> specify the <span class="keyword">access</span> log <span class="keyword">file</span> <span class="keyword">and</span> / <span class="keyword">or</span> log format, <span class="keyword">use</span> the -f <span class="keyword">and</span> -a options.</span><br><span class="line"></span><br><span class="line">    <span class="string">"top"</span> like view <span class="keyword">of</span> nginx requests</span><br><span class="line">    $ ngxtop</span><br><span class="line"></span><br><span class="line">    Top <span class="number">10</span> requested path <span class="keyword">with</span> status <span class="number">404</span>:</span><br><span class="line">    $ ngxtop top request_path <span class="comment">--filter 'status == 404'</span></span><br><span class="line"></span><br><span class="line">    Top <span class="number">10</span> requests <span class="keyword">with</span> highest total bytes sent</span><br><span class="line">    $ ngxtop <span class="comment">--order-by 'avg(bytes_sent) * count'</span></span><br><span class="line"></span><br><span class="line">    Top <span class="number">10</span> remote address, e.g., who<span class="attribute">'s</span> hitting you the most</span><br><span class="line">    $ ngxtop <span class="comment">--group-by remote_addr</span></span><br><span class="line"></span><br><span class="line">    Print requests <span class="keyword">with</span> <span class="number">4</span>xx <span class="keyword">or</span> <span class="number">5</span>xx status, together <span class="keyword">with</span> status <span class="keyword">and</span> http referer</span><br><span class="line">    $ ngxtop -i <span class="attribute">'status</span> &gt;= <span class="number">400</span>' print request status http_referer</span><br><span class="line"></span><br><span class="line">    Average <span class="keyword">body</span> bytes sent <span class="keyword">of</span> <span class="number">200</span> responses <span class="keyword">of</span> requested path <span class="keyword">begin</span> <span class="keyword">with</span> <span class="attribute">'foo</span>':</span><br><span class="line">    $ ngxtop avg bytes_sent <span class="comment">--filter 'status == 200 and request_path.startswith("foo")'</span></span><br><span class="line"></span><br><span class="line">    Analyze apache <span class="keyword">access</span> log from remote machine using <span class="attribute">'common</span>' log format</span><br><span class="line">    $ ssh remote tail -f /var/log/apache2/<span class="keyword">access</span>.log | ngxtop -f common</span><br></pre></td></tr></table></figure></p>
<p>实际使用下来还是很方便的，可以很方便看到403／500／404等情况，有利于我们掌握当前的服务质量。</p>
<p>Enjoy~</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.harrycode.com/2014/05/20/nginx-monitoring-tool-ngxtop/" data-id="ci9txs1y7000decs68i0qwsut" class="article-share-link">分享到</a>
      

      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tool/">Tool</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-server-system-monitor-tool-collecting" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/15/linux-server-system-monitor-tool-collecting/" class="article-date">
  <time datetime="2014-05-15T08:50:00.000Z" itemprop="datePublished">2014-05-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/15/linux-server-system-monitor-tool-collecting/">Linux 服务端系统监控工具大起底</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言">前言</h1><p>没有好声音，再好的戏也出不来。<br>没有好工具，再好的服务器也出不来。</p>
<p>最近一直在做一些服务端系统调优的工作，频繁的和各种监控工具打交到。很多工具以及参数细节在用到时才发现已经记不起了，所以顺着这次系统调优，把常用的监控工具又都熟悉了一遍。好记性不如烂笔头儿，记下来留备后用。</p>
<p>需要说明的是，本文可能会很长，没耐性的以及有痔疮的同学慎入 :)</p>
<h1 id="1-_流量监控">1. 流量监控</h1><h2 id="1-1_Ifstat">1.1 Ifstat</h2><p>比较简易的网络监控工具，可以监控网卡的实时流量。当你只关心整机的流量而并不关心具体服务时，这个工具很趁手。</p>
<h3 id="1-1-1_安装">1.1.1 安装</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://pkgs.repoforge.org/ifstat/ifstat-1.1-1.2.el6.rf.x86_64.rpm&#10;rpm -ivh ifstat-1.1-1.2.el6.rf.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2_使用">1.1.2 使用</h3><p>老规矩，看下man<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS</span><br><span class="line">    ifstat accepts <span class="operator">the</span> following options:</span><br><span class="line"></span><br><span class="line">    -l  Enables monitoring <span class="operator">of</span> loopback interfaces <span class="keyword">for</span> which statistics are available. By default, ifstat monitors all non-loopback interfaces that are up.</span><br><span class="line">    <span class="comment"># ifstat 默认不监控环回网络接口， -l 之后可以看到环回网络接口的流量</span></span><br><span class="line">    -<span class="operator">a</span>  Enables monitoring <span class="operator">of</span> all interfaces found <span class="keyword">for</span> which statistics are available.</span><br><span class="line">    <span class="comment"># 监控所有网络接口</span></span><br><span class="line">    -z  Hides interface which counters are <span class="constant">null</span>, eg interfaces that are up but <span class="operator">not</span> used.</span><br><span class="line">    <span class="comment"># 隐藏统计数为空的网络接口</span></span><br><span class="line">    -i  Specifies <span class="operator">the</span> list <span class="operator">of</span> interfaces <span class="built_in">to</span> monitor, separated <span class="keyword">by</span> commas (<span class="keyword">if</span> <span class="operator">an</span> interface name has <span class="operator">a</span> <span class="constant">comma</span>, <span class="keyword">it</span> can be escaped <span class="operator">with</span> ’\’). Multiple instances <span class="operator">of</span> <span class="operator">the</span> options are added together.</span><br><span class="line">    <span class="comment"># -i 指定被监控的网络接口列表，逗号分割</span></span><br><span class="line">    -s  Equivalent <span class="built_in">to</span> -d snmp:[comm@][<span class="comment">#]host[/nn]] to poll a remote host through SNMP. See below for details.</span></span><br><span class="line">    <span class="comment"># 可以基于snmp协议，监控远端服务器</span></span><br><span class="line">    -h  Displays <span class="operator">a</span> <span class="keyword">short</span> help message.</span><br><span class="line">    -n  Turns off displaying <span class="operator">the</span> header periodically.</span><br><span class="line">    <span class="comment"># 关闭显示头信息(第一屏还是会有，超过一屏时就不会再有了)</span></span><br><span class="line">    -t  Adds <span class="operator">a</span> timestamp <span class="keyword">at</span> <span class="operator">the</span> beginning <span class="operator">of</span> <span class="keyword">each</span> <span class="built_in">line</span>.</span><br><span class="line">    <span class="comment"># 每行前添加时间戳</span></span><br><span class="line">    -T  Reports total bandwith <span class="keyword">for</span> all monitored interfaces.</span><br><span class="line">    <span class="comment"># 每行行尾添加一列，统计总流量</span></span><br><span class="line">    -A  Disables use <span class="operator">of</span> interface indexes: <span class="keyword">by</span> default, when polling mechanism is index based (snmp, ifmib), ifstat remembers indexes <span class="operator">of</span> monitored inter-faces <span class="built_in">to</span> poll only them. However, <span class="keyword">if</span> interfaces indexes change often (<span class="built_in">new</span> interfaces added, etc), you might loose some stats, hence this flag.Note that <span class="keyword">if</span> you ask ifstat <span class="built_in">to</span> monitor <span class="operator">a</span> non existent interface, <span class="keyword">it</span> will poll all interfaces <span class="keyword">until</span> <span class="keyword">it</span> finds <span class="operator">the</span> requested <span class="constant">one</span> (regardless <span class="operator">of</span> this flag) so you can poll <span class="keyword">for</span> <span class="operator">an</span> interface that goes up <span class="operator">and</span> down.</span><br><span class="line">    <span class="comment"># 关闭使用网络接口的索引。默认的网络接口轮寻机制是基于索引的，ifstat会从索引中找当前的网络接口而不会每次都使用系统调用。所以如果一台服务器的网络接口经常变更(譬如新增，等) 你可能会丢失一些信息。因此有了这个参数</span></span><br><span class="line">    -w  Uses fixed width columns, instead <span class="operator">of</span> enlarging them <span class="keyword">if</span> needed <span class="keyword">for</span> interfaces names <span class="built_in">to</span> fit.</span><br><span class="line">    <span class="comment"># 用固定的列宽代替自适应的列款</span></span><br><span class="line">    -W  Wrap <span class="keyword">lines</span> that are larger than <span class="operator">the</span> terminal width (implies -w). Wrapped <span class="keyword">lines</span> are prefixed <span class="operator">with</span> <span class="operator">a</span> cycling letter <span class="built_in">to</span> ease reading.</span><br><span class="line">    <span class="comment"># 如果每行的宽度超过屏幕宽度，自动换行。</span></span><br><span class="line">    -S  Keep stats updated <span class="command"><span class="keyword">on</span> <span class="title">the</span> <span class="title">same</span> <span class="title">line</span> <span class="title">if</span> <span class="title">possible</span> (<span class="title">no</span> <span class="title">scrolling</span> <span class="title">nor</span> <span class="title">wrapping</span>).</span></span><br><span class="line">    <span class="comment"># 输出结果不再是追加。而是更新同一行。</span></span><br><span class="line">    -b  Reports bandwith <span class="operator">in</span> kbits/<span class="built_in">sec</span> instead <span class="operator">of</span> kbytes/<span class="built_in">sec</span>.</span><br><span class="line">    <span class="comment"># kbit 代替 kbyte</span></span><br><span class="line">    -q  Quiet mode, warnings are <span class="operator">not</span> printed.</span><br><span class="line">    -v  Displays <span class="built_in">version</span> <span class="operator">and</span> <span class="operator">the</span> compiled-<span class="operator">in</span> drivers.</span><br><span class="line">       </span><br><span class="line">    delay</span><br><span class="line">        delay is <span class="operator">the</span> delay between updates <span class="operator">in</span> <span class="built_in">seconds</span>, which defaults <span class="built_in">to</span> <span class="number">1.</span>  A decimal <span class="built_in">number</span> can be specified <span class="keyword">for</span> intervals shorter than <span class="operator">a</span> <span class="keyword">second</span>. (<span class="built_in">min</span>-imum <span class="number">0.1</span>)</span><br><span class="line">A <span class="keyword">second</span> delay can also be specified (separated <span class="built_in">from</span> <span class="operator">the</span> <span class="keyword">first</span> <span class="constant">one</span> <span class="keyword">by</span> <span class="operator">a</span> ’/’). In that <span class="keyword">case</span> <span class="operator">the</span> <span class="keyword">first</span> delay will be used <span class="keyword">for</span> <span class="operator">the</span> <span class="keyword">first</span> poll <span class="keyword">after</span> <span class="built_in">start</span> <span class="operator">and</span> <span class="operator">the</span> <span class="keyword">second</span> <span class="constant">one</span> will be used <span class="keyword">for</span> all following polls (This can be used <span class="built_in">to</span> have <span class="operator">a</span> <span class="string">"fast"</span> <span class="built_in">start</span> when running <span class="keyword">for</span> <span class="operator">a</span> <span class="keyword">long</span> <span class="keyword">while</span> <span class="operator">with</span> <span class="operator">a</span> big delay).</span><br><span class="line">        <span class="comment"># 每次显示刷新的时间间隔。默认是1.也接受一个浮点数，最小为0.1. 接受一个第二间隔的参数，通过'/' 分割，如 0.1／3. 这种情况下，第一次显示使用0.1，后面显示的时间间隔使用3. (这种方式可以用来"快速"启动，然后缓慢轮寻)</span></span><br><span class="line">    count</span><br><span class="line">        count is <span class="operator">the</span> <span class="built_in">number</span> <span class="operator">of</span> updates <span class="keyword">before</span> stopping. If <span class="operator">not</span> specified, <span class="keyword">it</span> is unlimited.</span><br><span class="line">        <span class="comment"># 指定刷新的次数。如果不指定，默认无限。</span></span><br></pre></td></tr></table></figure></p>
<p>通常用法：<code>ifstat -a -t -T 0.1/2</code></p>
<h2 id="1-2_Iftop">1.2 Iftop</h2><p>和ifstat 相比，iftop提供更丰富的监控维度。可以细化到网卡甚至端口服务。当网络成为瓶颈时，这个工具可以很快帮你找出是哪个服务占用了你网卡以及流量。</p>
<h3 id="1-2-1_安装">1.2.1 安装</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//pkgs.repoforge.org/iftop/iftop-0.17-1.el6.rf.x86_64.rpm</span></span><br><span class="line">rpm -ivh iftop-<span class="number">0.17</span>-<span class="number">1</span><span class="class">.el6</span><span class="class">.rf</span><span class="class">.x86_64</span><span class="class">.rpm</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2-2_使用">1.2.2 使用</h3><p>老规矩， 看下man<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS</span><br><span class="line">    -h     Print <span class="operator">a</span> summary <span class="operator">of</span> usage.</span><br><span class="line">    -n     Don’t <span class="built_in">do</span> hostname lookups. <span class="comment">#不对ip做反向解析</span></span><br><span class="line">    -N     Do <span class="operator">not</span> <span class="built_in">resolve</span> port <span class="built_in">number</span> <span class="built_in">to</span> service names <span class="comment"># 不会把port解析成服务名</span></span><br><span class="line">    -p     Run <span class="operator">in</span> promiscuous mode, so that traffic which does <span class="operator">not</span> pass directly through <span class="operator">the</span> specified interface is also counted. <span class="comment"># 运行在混杂模式中，所以不是来自指定网络接口的流量也会被统计</span></span><br><span class="line">    -P     Turn <span class="command"><span class="keyword">on</span> <span class="title">port</span> <span class="title">display</span>. #显示端口号</span></span><br><span class="line">    -b     Don’t display bar graphs <span class="operator">of</span> traffic.</span><br><span class="line">    -B     Display bandwidth rates <span class="operator">in</span> <span class="keyword">bytes</span>/<span class="built_in">sec</span> rather than bits/<span class="built_in">sec</span>. <span class="comment">#显示byte</span></span><br><span class="line">    -i interface</span><br><span class="line">        Listen <span class="built_in">to</span> packets <span class="command"><span class="keyword">on</span> <span class="title">interface</span>. #指定网络接口</span></span><br><span class="line">    -f <span class="built_in">filter</span> code</span><br><span class="line">        Use  <span class="built_in">filter</span> code <span class="built_in">to</span> select <span class="operator">the</span> packets <span class="built_in">to</span> count. Only IP packets are ever counted, so <span class="operator">the</span> specified code is evaluated <span class="keyword">as</span> (<span class="built_in">filter</span> code) <span class="operator">and</span> ip.</span><br><span class="line">    -F net/mask</span><br><span class="line">        Specifies <span class="operator">a</span> network <span class="keyword">for</span> traffic analysis.  If specified, iftop will only <span class="built_in">include</span> packets flowing <span class="operator">in</span> <span class="built_in">to</span> <span class="operator">or</span> out <span class="operator">of</span> <span class="operator">the</span> given network, <span class="operator">and</span> packet direction  is  determined  <span class="built_in">relative</span>  <span class="built_in">to</span>  <span class="operator">the</span>  network  boundary, rather than <span class="built_in">to</span> <span class="operator">the</span> interface.  You may specify mask <span class="keyword">as</span> <span class="operator">a</span> dotted quad, such <span class="keyword">as</span> /<span class="number">255.255</span>.255.0, <span class="operator">or</span> <span class="keyword">as</span> <span class="operator">a</span> single <span class="built_in">number</span> specifying <span class="operator">the</span> <span class="built_in">number</span> <span class="operator">of</span> bits <span class="built_in">set</span> <span class="operator">in</span> <span class="operator">the</span> netmask, such <span class="keyword">as</span> /<span class="number">24.</span> <span class="comment"># 指定ip区段以及掩码</span></span><br><span class="line">    -c config <span class="built_in">file</span></span><br><span class="line">        Specifies <span class="operator">an</span> alternate config <span class="built_in">file</span>.  If <span class="operator">not</span> specified, iftop will use ~/.iftoprc <span class="keyword">if</span> <span class="keyword">it</span> exists.  See below <span class="keyword">for</span> <span class="operator">a</span> description <span class="operator">of</span> config <span class="built_in">files</span> <span class="comment">#可以指定配置文件，文件格式详见 man</span></span><br></pre></td></tr></table></figure></p>
<p>通常用法：<code>iftop -N -n -B -i em1</code></p>
<h3 id="1-2-3_显示">1.2.3 显示</h3><p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/199171/GwYk2VoQ4eG6knaEFwb0_iftop.png" alt="iftop.png"></p>
<ol>
<li>第一行：当前带宽</li>
<li>中间区域： 左-本机ip 中-远端ip 右-2／10／40 秒的实时流量</li>
<li>底部：<br> TX：发送<br> RX：接收<br> Total：总流量<br> comm: 从iftop启动到现在产生的流量<br> peak：当前流量峰值／s<br> 右侧三列： 2／10／40 秒的平均值</li>
</ol>
<h3 id="1-2-4_交互操作">1.2.4 交互操作</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Host <span class="keyword">display</span>:                          </span><br><span class="line"> <span class="keyword">n</span> - toggle DNS host resolution   #切换dns反向解析     </span><br><span class="line"> s - toggle show source host # 切换显示源主机           </span><br><span class="line"> <span class="keyword">d</span> - toggle show destination host # 切换显示目的主机     </span><br><span class="line"> t - cycle <span class="keyword">line</span> <span class="keyword">display</span> mode # 循环切换不同的展示模式 单行／多行           </span><br><span class="line"></span><br><span class="line">Port <span class="keyword">display</span>:                          </span><br><span class="line"> <span class="keyword">N</span> - toggle service resolution  #切换端口到服务解析        </span><br><span class="line"> S - toggle show source port    #切换展示源端口       </span><br><span class="line"> <span class="keyword">D</span> - toggle show destination port  #切换展示目的端口    </span><br><span class="line"> p - toggle port <span class="keyword">display</span>    #是否展示端口           </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Sorting:</span><br><span class="line"> 1/2/3 - <span class="keyword">sort</span> <span class="keyword">by</span> 1st/2nd/3rd column #1/2/3列排序</span><br><span class="line"> &lt; - <span class="keyword">sort</span> <span class="keyword">by</span> source name #源主机排序</span><br><span class="line"> &gt; - <span class="keyword">sort</span> <span class="keyword">by</span> dest name #目的主机排序</span><br><span class="line"> o - freeze current <span class="keyword">order</span> </span><br><span class="line"></span><br><span class="line">General:</span><br><span class="line"> P - <span class="keyword">pause</span> <span class="keyword">display</span>        </span><br><span class="line"> <span class="keyword">h</span> - toggle this <span class="keyword">help</span> <span class="keyword">display</span></span><br><span class="line"> b - toggle bar <span class="keyword">graph</span> <span class="keyword">display</span></span><br><span class="line"> B - cycle bar <span class="keyword">graph</span> average</span><br><span class="line">                                   </span><br><span class="line"> j/k - scroll <span class="keyword">display</span></span><br><span class="line"> f - <span class="keyword">edit</span> filter code</span><br><span class="line"> <span class="keyword">l</span> - <span class="keyword">set</span> screen filter</span><br><span class="line"> <span class="keyword">L</span> - lin/<span class="keyword">log</span> scales</span><br><span class="line"> ! - <span class="keyword">shell</span> command</span><br><span class="line"> q - quit</span><br><span class="line"> T - toggle cummulative <span class="keyword">line</span> totals</span><br></pre></td></tr></table></figure>
<h2 id="1-3_Iptraf">1.3 Iptraf</h2><pre><code>和iptop的功能比较类似，实时性更好一些，UI也更易懂。
</code></pre><h3 id="1-3-1_安装">1.3.1 安装</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> iptraf</span><br></pre></td></tr></table></figure>
<p>这东西纯界面的，menu也很清晰，就不多说了～</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/199171/mlS8w6p8Rt27r7lTk9Xc_traffic.png" alt="traffic.png"></p>
<h1 id="2-_CPU">2. CPU</h1><h2 id="2-1_vmstat">2.1 vmstat</h2><p>vmstat可以说是最常用的cpu监控工具了，不但可以监控cpu的使用情况，还以cpu为维度，列出了请求队列，内存，io，中断等信息，方便我们从多个维度观察cpu信息，及时找出瓶颈。</p>
<h3 id="使用">使用</h3><p><code>vmstat -t -S m 2</code> #每秒刷新，附带时间戳; 涉及到容量的单位为M(-S 的可选参数为  k/K/m/M 对应 1000/1024/1000000/1048576 bytes )</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">procs</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">memory</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">swap</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">io</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">system</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">cpu</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">timestamp</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"> <span class="comment">r</span>  <span class="comment">b</span>   <span class="comment">swpd</span>   <span class="comment">free</span>   <span class="comment">buff</span>  <span class="comment">cache</span>   <span class="comment">si</span>   <span class="comment">so</span>    <span class="comment">bi</span>    <span class="comment">bo</span>   <span class="comment">in</span>   <span class="comment">cs</span> <span class="comment">us</span> <span class="comment">sy</span> <span class="comment">id</span> <span class="comment">wa</span> <span class="comment">st</span></span><br><span class="line"> <span class="comment">5</span>  <span class="comment">0</span>      <span class="comment">0</span>    <span class="comment">228</span>   <span class="comment">2137</span>  <span class="comment">18902</span>    <span class="comment">0</span>    <span class="comment">0</span>     <span class="comment">1</span>    <span class="comment">13</span>    <span class="comment">0</span>    <span class="comment">0</span>  <span class="comment">1</span>  <span class="comment">1</span> <span class="comment">98</span>  <span class="comment">0</span>  <span class="comment">0	2014</span><span class="literal">-</span><span class="comment">05</span><span class="literal">-</span><span class="comment">15</span> <span class="comment">17:53:06</span> <span class="comment">CST</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>列</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>procs-r</td>
<td>执行队列中的进程数(等待被执行的进程数)</td>
</tr>
<tr>
<td>procs-b</td>
<td>等待I/O的进程数</td>
</tr>
<tr>
<td>memory-swpd</td>
<td>使用交换内存的大小</td>
</tr>
<tr>
<td>memory-free</td>
<td>空闲内存的大小</td>
</tr>
<tr>
<td>memory-buff</td>
<td>buffer使用的内存大小，一般对块设备读写会用到buff</td>
</tr>
<tr>
<td>memory-cache</td>
<td>cache使用的内存大小，一般对文件读写会用到cache</td>
</tr>
<tr>
<td>swap-si</td>
<td>由内存写入到交换区的大小</td>
</tr>
<tr>
<td>swap-so</td>
<td>由交换区写入到内存的大小</td>
</tr>
<tr>
<td>io-bi</td>
<td>写入块设备的块数。(单位是block)</td>
</tr>
<tr>
<td>io-bo</td>
<td>从块设备接收到的块数。(单位是block)</td>
</tr>
<tr>
<td>system-in</td>
<td>系统中断数，包括时钟中断</td>
</tr>
<tr>
<td>system-cs</td>
<td>系统的上下文切换数</td>
</tr>
<tr>
<td>cpu-us</td>
<td>用户进程使用CPU的百分比</td>
</tr>
<tr>
<td>cpu-sy</td>
<td>系统进程使用CPU的百分比</td>
</tr>
<tr>
<td>cpu-id</td>
<td>空闲PU的百分比</td>
</tr>
<tr>
<td>cpu-wa</td>
<td>等待I/O的CPU百分比</td>
</tr>
<tr>
<td>cpu-st</td>
<td>被虚拟机偷取的CPU百分比</td>
</tr>
</tbody>
</table>
<h2 id="2-2_mpstat">2.2 mpstat</h2><p>虽然 vmstat 已经很强大了，但随着多核cpu的出现，vmstat有时有些捉襟见肘。笔者之前遇到一个案例，在系统压力很大时，mysql slave服务器出现了较大的延迟，从vmstat看，io／cpu都不高。binlog同步没有延迟，但是在binlog重放时显然拖慢了整体进度。最后通过mpstat观察发现，只有一个核的使用率很高，而vmstat显示的平均值，所以整体很低。这就说明mysql的主从机制中，从服务器重放sql是单线程的，无法利用多核，难怪在系统繁忙时，数据会有延迟。好了，不吐槽了，我们接茬儿说回mpstat</p>
<h3 id="使用-1">使用</h3><p><code>mpstat -u -P [ALL|0,1,2...]</code><br>|# -P 代表查看CPU的情况 ALL会列出全部CPU,也可以指定核编号，”,”分割<br><code>mpstat -I [SUM|CPU|ALL]</code>(不太常用，因为-P的结果中也会有中断数)<br>|# -I 代表查看CPU中断  SUM为所有cpu汇总,CPU代表列出所有核的中断，ALL为前两者之和</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Linux <span class="number">2.6</span>.32-<span class="number">431.</span>el6.x86_64 (beta-<span class="number">01.</span>cloud) 	<span class="number">05</span>/<span class="number">15</span>/<span class="number">2014</span> 	_x86_64_	(<span class="number">24</span> CPU)</span><br><span class="line"></span><br><span class="line"><span class="number">08</span>:<span class="number">56</span>:<span class="number">32</span> PM  CPU    <span class="variable">%usr</span>   <span class="variable">%nice</span>    <span class="variable">%sys</span> <span class="variable">%iowait</span>    <span class="variable">%irq</span>   <span class="variable">%soft</span>  <span class="variable">%steal</span>  <span class="variable">%guest</span>   <span class="variable">%idle</span></span><br><span class="line"><span class="number">08</span>:<span class="number">56</span>:<span class="number">34</span> PM  all   <span class="number">10.17</span>    <span class="number">0.00</span>   <span class="number">11.28</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>   <span class="number">78.54</span></span><br><span class="line"><span class="number">08</span>:<span class="number">56</span>:<span class="number">34</span> PM    <span class="number">0</span>    <span class="number">0.50</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>   <span class="number">99.50</span></span><br><span class="line"><span class="number">08</span>:<span class="number">56</span>:<span class="number">34</span> PM    <span class="number">1</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">3.50</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>   <span class="number">96.50</span></span><br><span class="line"><span class="number">08</span>:<span class="number">56</span>:<span class="number">34</span> PM    <span class="number">2</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>  <span class="number">100.00</span></span><br><span class="line"><span class="number">08</span>:<span class="number">56</span>:<span class="number">34</span> PM    <span class="number">3</span>   <span class="number">30.43</span>    <span class="number">0.00</span>   <span class="number">34.78</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>   <span class="number">34.78</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>列</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>irq</td>
<td>硬中断的CPU百分比</td>
</tr>
<tr>
<td>soft</td>
<td>软中断的CPU百分比(其他的项参考vmstat章节)</td>
</tr>
</tbody>
</table>
<h1 id="3-_I／O">3. I／O</h1><h2 id="3-1_iostat">3.1 iostat</h2><h3 id="使用-2">使用</h3><p><code>iostat -x -t [-k/-m] 3</code><br> |# -x 会展示一些扩展数据<br> |# -t 会展示刷新时间<br> |# -k 以kbytes为单位做展示<br> |# -m 以mbytes为单位做展示</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">05</span>/<span class="number">15</span>/<span class="number">2014</span> <span class="number">06</span>:<span class="number">25</span>:<span class="number">35</span> PM</span><br><span class="line">avg-cpu:  <span class="variable">%user</span>   <span class="variable">%nice</span> <span class="variable">%system</span> <span class="variable">%iowait</span>  <span class="variable">%steal</span>   <span class="variable">%idle</span></span><br><span class="line">          <span class="number">10.38</span>    <span class="number">0.00</span>   <span class="number">10.89</span>    <span class="number">0.00</span>    <span class="number">0.00</span>   <span class="number">78.73</span></span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  <span class="variable">%util</span></span><br><span class="line">sda               <span class="number">0.00</span>  <span class="number">1017.00</span>    <span class="number">0.00</span>   <span class="number">23.00</span>     <span class="number">0.00</span>  <span class="number">8320.00</span>   <span class="number">361.74</span>     <span class="number">0.01</span>    <span class="number">0.22</span>   <span class="number">0.07</span>   <span class="number">0.15</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>列</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>nice</td>
<td>用做nice加权的进程分配的用户态cpu时间比(CPU的其它项，见vmstat章节)</td>
</tr>
<tr>
<td>rrqm/s</td>
<td>队列中每秒合并的读请求数</td>
</tr>
<tr>
<td>wrqm/s</td>
<td>队列中每秒合并的写请求数</td>
</tr>
<tr>
<td>r/s</td>
<td>每秒完成的读请求数</td>
</tr>
<tr>
<td>w/s</td>
<td>每秒完成的写请求数</td>
</tr>
<tr>
<td>rsec/s</td>
<td>每秒读取的扇区数</td>
</tr>
<tr>
<td>wsec/s</td>
<td>每秒写入的扇区数</td>
</tr>
<tr>
<td>avgrq-sz</td>
<td>平均每次io操作的扇区大小(单位为扇区)</td>
</tr>
<tr>
<td>avgqu-sz</td>
<td>I／O队列的平均长度</td>
</tr>
<tr>
<td>await</td>
<td>每次I/O请求的处理时间。这个时间包括排队时间+处理时间 (ms)</td>
</tr>
<tr>
<td>svctm</td>
<td>每次I/O请求的处理时间。这个时间不包括排队时间 (ms)</td>
</tr>
<tr>
<td>%util</td>
<td>I/O请求所占用的CPU时间百分比(<strong>这一项是衡量i/o负载的重要指标</strong>)</td>
</tr>
</tbody>
</table>
<h2 id="3-2_iotop">3.2 iotop</h2><p>iostat 是从宏观上监控系统i/o的整体情况，于是它就存在个弱点，当我们发现系统i/o过高甚至成为瓶颈时，无法查看到底是哪个进程导致的io过高。这个时候就iotop出场了。<br>关于iotop的介绍，详见前几日的博文 <a href="http://harrycode.logdown.com/posts/198725-introduction-to-iotop" target="_blank" rel="external">IOTop 简介</a></p>
<h1 id="4-_综合">4. 综合</h1><p>这个世界有小而精的东西，也永远都不缺大而全的东西</p>
<h2 id="4-1_htop">4.1 htop</h2><p>htop是top的增强版，功能更强大，性能更好。详细的介绍参见之前的一篇博客 <a href="http://harrycode.logdown.com/posts/198662-change-replacing-the-top-process-management-tools-under-linux-htop" target="_blank" rel="external">[转]Linux下取代top的进程管理工具 htop</a></p>
<h2 id="4-2_sar">4.2 sar</h2><p>sar可以快速收集服务器上的各项信息并显示，包括CPU，内存，I/O，中断，IP，TCP，UDP等。<br>这个工具通常都被预装在了服务器上，如果真的那么悲催居然没有，可以去找这个工具集 [sysstat][1] </p>
<h2 id="用法">用法</h2><p><code>sar [ 选项 ] [ &lt;时间间隔&gt; [ &lt;次数&gt; ] ]</code></p>
<p><strong>不带任何选项的sar，默认展示cpu信息</strong><br>展示的各项与mpstat一致，相关描述可参考mpstat -P的章节</p>
<p><code>sar 2</code></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Linux <span class="number">2.6</span>.32-<span class="number">431.</span>el6.x86_64 (beta-<span class="number">01.</span>cloud) 	<span class="number">05</span>/<span class="number">15</span>/<span class="number">2014</span> 	_x86_64_	(<span class="number">24</span> CPU)</span><br><span class="line"></span><br><span class="line"><span class="number">09</span>:<span class="number">24</span>:<span class="number">03</span> PM     CPU     <span class="variable">%user</span>     <span class="variable">%nice</span>   <span class="variable">%system</span>   <span class="variable">%iowait</span>    <span class="variable">%steal</span>     <span class="variable">%idle</span></span><br><span class="line"><span class="number">09</span>:<span class="number">24</span>:<span class="number">05</span> PM     all     <span class="number">10.09</span>      <span class="number">0.00</span>     <span class="number">11.20</span>      <span class="number">0.00</span>      <span class="number">0.00</span>     <span class="number">78.71</span></span><br><span class="line"><span class="number">09</span>:<span class="number">24</span>:<span class="number">07</span> PM     all     <span class="number">10.33</span>      <span class="number">0.00</span>     <span class="number">11.05</span>      <span class="number">0.00</span>      <span class="number">0.00</span>     <span class="number">78.62</span></span><br></pre></td></tr></table></figure>
<p><strong>-b    I/O 和传输速率信息状况</strong></p>
<p><code>sar -b 2</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Linux <span class="number">2.6</span>.<span class="number">32</span>-<span class="number">431</span><span class="class">.el6</span><span class="class">.x86_64</span> (beta-<span class="number">01</span>.cloud) 	<span class="number">05</span>/<span class="number">15</span>/<span class="number">2014</span> 	_x86_64_	(<span class="number">24</span> CPU)</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>:<span class="number">17</span>:<span class="number">26</span> PM       tps      rtps      wtps   bread/s   bwrtn/s</span><br><span class="line"><span class="number">04</span>:<span class="number">17</span>:<span class="number">29</span> PM    <span class="number">481.00</span>      <span class="number">0.00</span>    <span class="number">481.00</span>      <span class="number">0.00</span>   <span class="number">4856.00</span></span><br><span class="line"><span class="number">04</span>:<span class="number">17</span>:<span class="number">32</span> PM      <span class="number">4.67</span>      <span class="number">0.00</span>      <span class="number">4.67</span>      <span class="number">0.00</span>    <span class="number">752.00</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>列</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>tps</td>
<td>每秒对物理磁盘的I/O请求数</td>
</tr>
<tr>
<td>rtps</td>
<td>每秒对物理磁盘的I/O读请求数</td>
</tr>
<tr>
<td>wtps</td>
<td>每秒对物理磁盘的I/O写请求数</td>
</tr>
<tr>
<td>bread/s</td>
<td>每秒从物理磁盘读取的数据块(block)数目。2.4及以上，一个block为512bytes</td>
</tr>
<tr>
<td>bwrtn/s</td>
<td>每秒对物理磁盘写的数据块数目</td>
</tr>
</tbody>
</table>
<p><strong>-d  块设备的使用情况</strong></p>
<p><code>sar -p -d 2</code></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sarLinux <span class="number">2.6</span>.<span class="number">32</span>-<span class="number">431</span>.el6.x86_64 (beta-<span class="number">01</span>.cloud) 	<span class="number">05</span><span class="regexp">/15/</span><span class="number">2014</span> 	_x86_64_	(<span class="number">24</span> CPU)</span><br><span class="line"></span><br><span class="line"><span class="number">05</span>:<span class="number">11</span>:<span class="number">06</span> PM       DEV       tps  rd_sec<span class="regexp">/s  wr_sec/</span>s  avgrq-sz  avgqu-sz     await     svctm     %util</span><br><span class="line"><span class="number">05</span>:<span class="number">11</span>:<span class="number">09</span> PM       sda      <span class="number">1.34</span>      <span class="number">0.00</span>     <span class="number">58.86</span>     <span class="number">44.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span></span><br><span class="line"></span><br><span class="line"><span class="number">05</span>:<span class="number">11</span>:<span class="number">09</span> PM       DEV       tps  rd_sec<span class="regexp">/s  wr_sec/</span>s  avgrq-sz  avgqu-sz     await     svctm     %util</span><br><span class="line"><span class="number">05</span>:<span class="number">11</span>:<span class="number">12</span> PM       sda      <span class="number">1.99</span>      <span class="number">0.00</span>    <span class="number">685.71</span>    <span class="number">344.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>列</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEV</td>
<td>被监控的块设备名称</td>
</tr>
<tr>
<td>tps</td>
<td>每秒传输给块设备的请求数(I/O请求数)。多个逻辑请求会被合并成一个物理请求</td>
</tr>
<tr>
<td>rd_sec/s</td>
<td>每秒读取的扇区数(sector)。一个扇区512bytes</td>
</tr>
<tr>
<td>wr_sec/s</td>
<td>每秒写入的扇区数(sector)。一个扇区512bytes</td>
</tr>
<tr>
<td>avgrq-sz</td>
<td>平均每次I/O请求的扇区数</td>
</tr>
<tr>
<td>avgqu-sz</td>
<td>I/O请求队列的平均长度</td>
</tr>
<tr>
<td>await</td>
<td>每次I/O请求的处理时间。这个时间包括排队时间+处理时间 (ms)</td>
</tr>
<tr>
<td>svctm</td>
<td>每次I/O请求的处理时间。这个时间不包括排队时间 (ms)</td>
</tr>
<tr>
<td>%util</td>
<td>I/O请求所占用的CPU时间百分比(<strong>这一项是衡量i/o负载的重要指标</strong>)</td>
</tr>
</tbody>
</table>
<p><strong>-P cpu的使用情况，支持多核， 与mpstat 一致</strong></p>
<p><code>sar -P [ALL|0,1,2...] 2</code></p>
<p><strong>-q   队列以及负载的情况</strong></p>
<p><code>sar -q 2</code></p>
<table>
<thead>
<tr>
<th>列</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>runq-sz</td>
<td>准备进入执行队列的进程数</td>
</tr>
<tr>
<td>plist-sz</td>
<td>进程列表中的进程数</td>
</tr>
<tr>
<td>ldavg-1</td>
<td>最近一分钟的系统负载</td>
</tr>
<tr>
<td>ldavg-5</td>
<td>最近5分钟的系统负载</td>
</tr>
<tr>
<td>ldavg-15</td>
<td>最近15分钟的系统负载</td>
</tr>
</tbody>
</table>
<p><strong>-n  网络相关的情况</strong></p>
<p>根据关键字来基于不同维度展示网络相关的情况，关键字包括 DEV, EDEV, NFS, NFSD, SOCK, IP, EIP, ICMP, EICMP, TCP, ETCP, UDP, SOCK6, IP6, EIP6, ICMP6, EICMP6 and UDP6， 较为常用的是 DEV和SOCK</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DEV</strong></td>
<td>所有网络设备的活动统计</td>
</tr>
<tr>
<td>IFACE</td>
<td>网络接口名</td>
</tr>
<tr>
<td>rxpck/s</td>
<td>每秒收到的package</td>
</tr>
<tr>
<td>txpck/s</td>
<td>每秒发送的package</td>
</tr>
<tr>
<td>rxkB/s</td>
<td>每秒收到的字节数</td>
</tr>
<tr>
<td>txkB/s</td>
<td>每秒发送的字节数</td>
</tr>
<tr>
<td>rxcmp/s</td>
<td>每秒收到的压缩包数</td>
</tr>
<tr>
<td>txcmp/s</td>
<td>每秒发送的压缩包数</td>
</tr>
<tr>
<td>rxmcst/s</td>
<td>每秒收到的多播包数</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>SOCK</strong></td>
<td>所有网络套接字的活动统计</td>
</tr>
<tr>
<td>totsck</td>
<td>使用的套接字总数</td>
</tr>
<tr>
<td>tcpsck</td>
<td>使用的Tcp套接字总数</td>
</tr>
<tr>
<td>udpsck</td>
<td>使用的Udp套接字总数</td>
</tr>
<tr>
<td>rawsck</td>
<td>使用的Raw套接字总数</td>
</tr>
<tr>
<td>ip-frag</td>
<td>使用的ip段总数</td>
</tr>
<tr>
<td>tcp-tw</td>
<td>当前Time_Wait的套接字总数</td>
</tr>
</tbody>
</table>
<p>就这么多吧，敲的手抖，把最近用到的工具简单罗列了下下，希望对大家有用。<br>需要注意一下，上面的演示都是基于CentOSd的，其他操作系统中，同样的工具输出结果会略有不同，要想了解细节还是要靠 man.</p>
<p>Enjoy~</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.harrycode.com/2014/05/15/linux-server-system-monitor-tool-collecting/" data-id="ci9txs1y9000iecs6ll2ptijg" class="article-share-link">分享到</a>
      

      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tools/">Tools</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-introduction-to-iotop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/13/introduction-to-iotop/" class="article-date">
  <time datetime="2014-05-13T05:19:00.000Z" itemprop="datePublished">2014-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/13/introduction-to-iotop/">IOTop 简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介">简介</h2><p>IOTop 是一款Python程序，使用Top的UI样式， 可以查看基于进程／线程／User等多种维度来查看／监控服务器当前的I/O情况</p>
<h2 id="安装">安装</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//guichaz.free.fr/iotop/files/iotop-0.6-1.noarch.rpm</span></span><br><span class="line">sudo rpm -ivh iotop-<span class="number">0.6</span>-<span class="number">1</span><span class="class">.noarch</span><span class="class">.rpm</span></span><br></pre></td></tr></table></figure>
<h2 id="使用">使用</h2><p>简单翻译下 —help ，用法很简单</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">beta-<span class="number">01</span><span class="comment"># iotop --help</span></span><br><span class="line">Usage: /usr/sbin/iotop [OPTIONS]</span><br><span class="line"></span><br><span class="line">DISK READ <span class="operator">and</span> DISK WRITE are <span class="operator">the</span> block I/O bandwidth used during <span class="operator">the</span> sampling</span><br><span class="line">period. SWAPIN <span class="operator">and</span> IO are <span class="operator">the</span> percentages <span class="operator">of</span> <span class="built_in">time</span> <span class="operator">the</span> thread spent respectively</span><br><span class="line"><span class="keyword">while</span> swapping <span class="operator">in</span> <span class="operator">and</span> waiting <span class="command"><span class="keyword">on</span> <span class="title">I</span>/<span class="title">O</span> <span class="title">more</span> <span class="title">generally</span>. <span class="title">PRIO</span> <span class="title">is</span> <span class="title">the</span> <span class="title">I</span>/<span class="title">O</span> <span class="title">priority</span> <span class="title">at</span></span></span><br><span class="line">which <span class="operator">the</span> thread is running (<span class="built_in">set</span> <span class="keyword">using</span> <span class="operator">the</span> ionice <span class="command"><span class="keyword">command</span>).</span></span><br></pre></td></tr></table></figure>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Options:</span><br><span class="line">  -<span class="ruby">-version             show program<span class="string">'s version number and exit</span><br><span class="line"></span></span>  -<span class="ruby">h, --help            show this help message <span class="keyword">and</span> exit</span><br><span class="line"></span>  -<span class="ruby">o, --only            only show processes <span class="keyword">or</span> threads actually doing <span class="constant">I</span>/<span class="constant">O</span> <span class="comment">#只显示当前有IO操作的进程或线程</span></span><br><span class="line"></span>  -<span class="ruby">b, --batch           non-interactive mode <span class="comment"># 运行在非交互模式下</span></span><br><span class="line"></span>  -<span class="ruby">n <span class="constant">NUM</span>, --iter=<span class="constant">NUM</span>    number of iterations before ending [infinite] <span class="comment"># 非交互模式下展示的次数</span></span><br><span class="line"></span>  -<span class="ruby">d <span class="constant">SEC</span>, --delay=<span class="constant">SEC</span>   delay between iterations [<span class="number">1</span> second] <span class="comment">#刷新的时间间隔</span></span><br><span class="line"></span>  -<span class="ruby">p <span class="constant">PID</span>, --pid=<span class="constant">PID</span>     processes/threads to monitor [all] <span class="comment">#只显示指定进程／线程的IO信息</span></span><br><span class="line"></span>  -<span class="ruby">u <span class="constant">USER</span>, --user=<span class="constant">USER</span>  users to monitor [all] <span class="comment">#只显示指定用户的进程所发生的IO</span></span><br><span class="line"></span>  -<span class="ruby"><span class="constant">P</span>, --processes       only show processes, <span class="keyword">not</span> all threads <span class="comment"># 只显示进程而不是所有的线程</span></span><br><span class="line"></span>  -<span class="ruby">a, --accumulated     show accumulated <span class="constant">I</span>/<span class="constant">O</span> instead of bandwidth <span class="comment">#在IOTOP启动后 显示每个进程／线程处理的IO总数</span></span><br><span class="line"></span>  -<span class="ruby">k, --kilobytes       use kilobytes instead of a human friendly unit <span class="comment"># 以KB为单位进行显示</span></span><br><span class="line"></span>  -<span class="ruby">t, --time            add a timestamp on each line (implies --batch) <span class="comment"># 显示时在每行添加当前时间</span></span><br><span class="line"></span>  -<span class="ruby">q, --quiet           suppress some lines of header (implies --batch)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Controls: left <span class="operator">and</span> <span class="constant">right</span> arrows <span class="built_in">to</span> change <span class="operator">the</span> sorting column, r <span class="built_in">to</span> invert <span class="operator">the</span></span><br><span class="line">sorting order, o <span class="built_in">to</span> toggle <span class="operator">the</span> <span class="comment">--only option, p to toggle the --processes</span></span><br><span class="line">option, <span class="operator">a</span> <span class="built_in">to</span> toggle <span class="operator">the</span> <span class="comment">--accumulated option, q to quit, any other key to force</span></span><br><span class="line"><span class="operator">a</span> refresh.</span><br><span class="line"></span><br><span class="line">控制：</span><br><span class="line"><span class="string">'左右键'</span>用来改变排序的列，</span><br><span class="line"><span class="string">'r'</span>用来切换正序/倒序, </span><br><span class="line"><span class="string">'o'</span> 用来切换 <span class="comment">--only模式, </span></span><br><span class="line"><span class="string">'p'</span> 用来切换 <span class="comment">--processes 模式， </span></span><br><span class="line"><span class="string">'a'</span> 用来切换 <span class="comment">--accumulated模式, </span></span><br><span class="line"><span class="string">'q'</span> 用来推出，‘其他键’ 用来强制刷新</span><br></pre></td></tr></table></figure>
<p>PS: 笔者很喜欢 iotop -o 的玩法，祝大家也玩的愉快。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.harrycode.com/2014/05/13/introduction-to-iotop/" data-id="ci9txs1yb000mecs6rrqg3c0b" class="article-share-link">分享到</a>
      

      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tools/">Tools</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-change-replacing-the-top-process-management-tools-under-linux-htop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/12/change-replacing-the-top-process-management-tools-under-linux-htop/" class="article-date">
  <time datetime="2014-05-12T13:14:00.000Z" itemprop="datePublished">2014-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/12/change-replacing-the-top-process-management-tools-under-linux-htop/">[转]Linux下取代top的进程管理工具 htop</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文转自  <a href="http://www.cnblogs.com/mchina/archive/2013/03/15/2858041.html" target="_blank" rel="external">http://www.cnblogs.com/mchina/archive/2013/03/15/2858041.html</a></p>
<h1 id="htop_简介">htop 简介</h1><p>This is htop, an interactive process viewer for Linux. It is a text-mode application (for console or X terminals) and requires ncurses.</p>
<p><strong>Comparison between htop and top</strong></p>
<ul>
<li>In ‘htop’ you can scroll the list vertically and horizontally to see all processes and complete command lines.</li>
<li>In ‘top’ you are subject to a delay for each unassigned key you press (especially annoying when multi-key escape sequences are triggered by accident).</li>
<li>‘htop’ starts faster (‘top’ seems to collect data for a while before displaying anything).</li>
<li>In ‘htop’ you don’t need to type the process number to kill a process, in ‘top’ you do.</li>
<li>In ‘htop’ you don’t need to type the process number or the priority value to renice a process, in ‘top’ you do.</li>
<li>‘htop’ supports mouse operation, ‘top’ doesn’t</li>
<li>‘top’ is older, hence, more used and tested.</li>
</ul>
<p>htop 是Linux系统中的一个互动的进程查看器，一个文本模式的应用程序(在控制台或者X终端中)，需要ncurses。<br>与Linux传统的top相比，htop更加人性化。它可让用户交互式操作，支持颜色主题，可横向或纵向滚动浏览进程列表，并支持鼠标操作。</p>
<p><strong>与top相比，htop有以下优点：</strong></p>
<ul>
<li>可以横向或纵向滚动浏览进程列表，以便看到所有的进程和完整的命令行。</li>
<li>在启动上，比top 更快。</li>
<li>杀进程时不需要输入进程号。</li>
<li>htop 支持鼠标操作。</li>
<li>top 已经很老了。</li>
</ul>
<p>htop 官网：<a href="http://htop.sourceforge.net/" target="_blank" rel="external">http://htop.sourceforge.net/</a></p>
<h1 id="htop_安装">htop 安装</h1><p><strong>a. 源码包安装</strong><br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># tar zxvf htop-1.0.2.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd htop-1.0.2</span></span><br><span class="line"><span class="preprocessor"># ./configure</span></span><br><span class="line"><span class="preprocessor"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p>若出现错误：<br>configure: error: You may want to use —disable-unicode or install libncursesw.<br>则需安装 ncurses-devel<br><code>yum install ncurses-devel</code></p>
<p><strong>b. RHEL/CentOS 安装</strong></p>
<p>可以通过 yum install htop 来安装它，但前提是要添加epel 的yum源，具体请参考 CentOS yum 源的配置与使用。<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># rpm --import http://apt.sw.be/RPM-GPG-KEY.dag.txt</span></span><br><span class="line"><span class="preprocessor"># wget http://pkgs.repoforge.org/rpmforge-release/rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm</span></span><br><span class="line"><span class="preprocessor"># rpm -K rpmforge-release-0.5.3-1.el6.rf.*.rpm</span></span><br><span class="line"><span class="preprocessor"># rpm -i rpmforge-release-0.5.3-1.el6.rf.*.rpm</span></span><br><span class="line"><span class="preprocessor"># yum install htop</span></span><br></pre></td></tr></table></figure></p>
<h1 id="htop_参数">htop 参数</h1><p>键入htop 命令，打开htop。</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/EO2b6zTCT8eEv3oi8sRi_12224048-e798f9f6de94490885989b39970a8270.jpg" alt="12224048-e798f9f6de94490885989b39970a8270.jpg"></p>
<p>上面左上角显示CPU、内存、交换区的使用情况，右边显示任务、负载、开机时间，下面就是进程实时状况。<br>下面是 F1~F10 的功能和对应的字母快捷键。</p>
<table>
<thead>
<tr>
<th>Shortcut Key</th>
<th>Function Key</th>
<th>Description</th>
<th>中文说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>h, ?</td>
<td>F1</td>
<td>Invoke htop Help</td>
<td>查看htop使用说明</td>
</tr>
<tr>
<td>S</td>
<td>F2</td>
<td>Htop Setup Menu</td>
<td>htop 设定</td>
</tr>
<tr>
<td>/</td>
<td>F3</td>
<td>Search for a Process</td>
<td>搜索进程</td>
</tr>
<tr>
<td>\</td>
<td>F4</td>
<td>Incremental process filtering</td>
<td>增量进程过滤器</td>
</tr>
<tr>
<td>t</td>
<td>F5</td>
<td>Tree View</td>
<td>显示树形结构</td>
</tr>
<tr>
<td>&lt;, &gt;</td>
<td>F6</td>
<td>Sort by a column</td>
<td>选择排序方式</td>
</tr>
<tr>
<td>[</td>
<td>F7</td>
<td>Nice - (change priority)</td>
<td>可减少nice值，这样就可以提高对应进程的优先级</td>
</tr>
<tr>
<td>]</td>
<td>F8</td>
<td>Nice + (change priority)</td>
<td>可增加nice值，这样就可以降低对应进程的优先级</td>
</tr>
<tr>
<td>k</td>
<td>F9</td>
<td>Kill a Process</td>
<td>可对进程传递信号</td>
</tr>
<tr>
<td>q</td>
<td>F10</td>
<td>Quit htop</td>
<td>结束htop</td>
</tr>
</tbody>
</table>
<p><strong>命令行选项（COMMAND-LINE OPTIONS）</strong></p>
<p>-C —no-color　　　　 　　 使用一个单色的配色方案<br>-d —delay=DELAY　　　　 设置延迟更新时间，单位秒<br>-h —help　　　　　　  　　 显示htop 命令帮助信息<br>-u —user=USERNAME　　  只显示一个给定的用户的过程<br>-p —pid=PID,PID…　　　    只显示给定的PIDs<br>-s —sort-key COLUMN　    依此列来排序<br>-v –version　　　　　　　   显示版本信息</p>
<p><strong>交互式命令（INTERACTIVE COMMANDS）</strong></p>
<table>
<thead>
<tr>
<th>上下键或PgUP, PgDn</th>
<th>选定想要的进程</th>
</tr>
</thead>
<tbody>
<tr>
<td>左右键或Home, End</td>
<td>移动字段，当然也可以直接用鼠标选定进程；</td>
</tr>
<tr>
<td>Space</td>
<td>标记/取消标记一个进程。命令可以作用于多个进程，例如 “kill”，将应用于所有已标记的进程</td>
</tr>
<tr>
<td>U</td>
<td>取消标记所有进程</td>
</tr>
<tr>
<td>s</td>
<td>选择某一进程，按s:用strace追踪进程的系统调用</td>
</tr>
<tr>
<td>l</td>
<td>显示进程打开的文件: 如果安装了lsof，按此键可以显示进程所打开的文件</td>
</tr>
<tr>
<td>I</td>
<td>倒转排序顺序，如果排序是正序的，则反转成倒序的，反之亦然</td>
</tr>
<tr>
<td>+, -</td>
<td>When in tree view mode, expand or collapse subtree. When a subtree is collapsed a “+” sign shows to the left of the process name.</td>
</tr>
<tr>
<td>a (在有多处理器的机器上)</td>
<td>设置 CPU affinity: 标记一个进程允许使用哪些CPU</td>
</tr>
<tr>
<td>u</td>
<td>显示特定用户进程</td>
</tr>
<tr>
<td>M</td>
<td>按Memory 使用排序</td>
</tr>
<tr>
<td>P</td>
<td>按CPU 使用排序</td>
</tr>
<tr>
<td>T</td>
<td>按Time+ 使用排序</td>
</tr>
<tr>
<td>F</td>
<td>跟踪进程: 如果排序顺序引起选定的进程在列表上到处移动，让选定条跟随该进程。这对监视一个进程非常有用：通过这种方式，你可以让一个进程在屏幕上一直可见。使用方向键会停止该功能。</td>
</tr>
<tr>
<td>K</td>
<td>显示/隐藏内核线程</td>
</tr>
<tr>
<td>H</td>
<td>显示/隐藏用户线程</td>
</tr>
<tr>
<td>Ctrl-L</td>
<td>刷新</td>
</tr>
<tr>
<td>Numbers</td>
<td>PID 查找: 输入PID，光标将移动到相应的进程上</td>
</tr>
</tbody>
</table>
<h1 id="htop_使用">htop 使用</h1><h2 id="显示自带帮助">显示自带帮助</h2><p>鼠标点击Help或者按F1 显示自带帮助</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/bbtswYdaQsO6nxRL7Gea_12224050-75be8605449248f999bde75c6697522f.jpg" alt="12224050-75be8605449248f999bde75c6697522f.jpg"></p>
<h2 id="htop_设定">htop 设定</h2><p>鼠标点击Setup或者按下F2 之后进入htop 设定的页面，Meters 页面设定了顶端的一些信息显示，顶端的显示又分为左右两侧，到底能显示些什么可以在最右侧那栏新增，要新增到上方左侧（F5）或是右侧（F6）都可以，这就是个人设定的范围了。这里多加了一个时钟。</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/YPmTpe7bQBOnHyFrEaQE_12224052-570be85130854977aa4bc9f796fb0eb1.jpg" alt="12224052-570be85130854977aa4bc9f796fb0eb1.jpg"></p>
<p>上方左右两栏的显示方式分为Text Bar Graph Led 四种，下图我就把 cpu memory swap 改成文本模式显示，然后右栏的改成Bar 显示，clock 用LED方式显示。数据显示都差不多，只是这样看有点不习惯了。</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/AxJXcJalQGal98aIFO3i_12224053-eca0d56c388240e495c0b3226ed45472.jpg" alt="12224053-eca0d56c388240e495c0b3226ed45472.jpg"></p>
<p>关于Display options 的设定，可要根据管理者自己的需要来设定。</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/9v3VH9ClSouJgF6vH0X3_12224054-97538b88011d4b6fb49e7d48ec7b4263.jpg" alt="12224054-97538b88011d4b6fb49e7d48ec7b4263.jpg"></p>
<p>颜色选择，除了基本的颜色显示之外，htop 还提供了换面板的功能，其实也只是改变一些色彩显示的设定，虽然说不能自定义到细部的颜色显示，但是至少提供了几种风格可以选择。</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/Rk8VkpY2RI6pM4Qodmoe_12224056-2f6114304f37492095545a4ad6a68986.jpg" alt="12224056-2f6114304f37492095545a4ad6a68986.jpg"></p>
<p>最后一项的设定是调整 Columns 的显示，就是在一般htop 指令进来希望可以看到的什么样的数据及信息，字段的调整可以在这边做个人化的设定，一般使用系统默认值就好了。</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/hxFqEnM7RJO7KmynsnHu_12224059-a5ece1fdc31e420da897d01167e97550.jpg" alt="12224059-a5ece1fdc31e420da897d01167e97550.jpg"></p>
<h2 id="搜索进程">搜索进程</h2><p>鼠标点击Search 或者按下F3 或者输入”/“， 输入进程名进行搜索，例如搜索ssh</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/tpHBqvDqSCyZsmVipLSy_12224101-da92613d580148e7a74b5bde960bbbb8.jpg" alt="12224101-da92613d580148e7a74b5bde960bbbb8.jpg"></p>
<h2 id="过滤器">过滤器</h2><p>按下F4，进入过滤器，相当于关键字搜索，不区分大小写，例如过滤dev</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/N4ST8R9wSh2X2l5EQ6Tt_12224103-ee01abbe5a7d4f5388057a52bd52e109.jpg" alt="12224103-ee01abbe5a7d4f5388057a52bd52e109.jpg"></p>
<h2 id="显示树形结构">显示树形结构</h2><p>输入”t”或按下F5，显示树形结构，意思跟pstree 差不多，能看到所有程序树状执行的结构，这对于系统管理来说相当方便，理清程序是如何产生的，当然树状结构的浏览也可以依照其他数据来排序。</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/1ltROwUtTz6WPjCs0PrQ_12224105-44b98e747b494234929f8af4e3eeb5e4.jpg" alt="12224105-44b98e747b494234929f8af4e3eeb5e4.jpg"></p>
<h2 id="选择排序方式">选择排序方式</h2><p>按下F6 就可以选择依照什么来排序，最常排序的内容就是cpu 和memory 吧！</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/qShoFiiTICm4u6C9kpWg_12224111-2f34d96612bd420ebcf9471c7339fc63.jpg" alt="12224111-2f34d96612bd420ebcf9471c7339fc63.jpg"></p>
<h2 id="操作进程">操作进程</h2><p>F7、F8分别对应nice-和nice+，F9对应kill给进程发信号，选好信号回车就OK了</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/9cuJq5SGQfm4Jt87QcnB_12224113-0e383c20b0e74196a393586b72a67ba1.jpg" alt="12224113-0e383c20b0e74196a393586b72a67ba1.jpg"></p>
<h2 id="显示某个用户的进程，在左侧选择用户">显示某个用户的进程，在左侧选择用户</h2><p>输入”u”，在左侧选择用户</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/198662/Rj7joHcVQLai0GctiCHa_12224116-5b7ca92b8c644464a65a11204e346f49.jpg" alt="12224116-5b7ca92b8c644464a65a11204e346f49.jpg"></p>
<h1 id="Alias_top">Alias top</h1><p>也许你用惯了top，我们也可以用top来打开htop。</p>
<p>编辑/root/.bashrc文件，添加如下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="operator">-f</span> /usr/<span class="built_in">local</span>/bin/htop ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">alias</span> top=’/usr/<span class="built_in">local</span>/bin/htop’</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p><code>source /root/.bashrc</code></p>
<p>本文转自  <a href="http://www.cnblogs.com/mchina/archive/2013/03/15/2858041.html" target="_blank" rel="external">http://www.cnblogs.com/mchina/archive/2013/03/15/2858041.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.harrycode.com/2014/05/12/change-replacing-the-top-process-management-tools-under-linux-htop/" data-id="ci9txs1yg000secs6jq26e2j6" class="article-share-link">分享到</a>
      

      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tools/">Tools</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-installation-configuration-and-use-of-mysqlnd-ms" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/10/installation-configuration-and-use-of-mysqlnd-ms/" class="article-date">
  <time datetime="2014-05-10T02:21:00.000Z" itemprop="datePublished">2014-05-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/10/installation-configuration-and-use-of-mysqlnd-ms/">Mysqlnd_ms的安装配置与使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>公司最近需要一个扩展性良好的Mysql主从分离方案，老大要求对业务层的代码改动要小。<br>业务层代码改动小，意味着要在连接层直接把读／写请求分发，而不是到业务层通过”SQL识别”的来分离。<br>脑子里有两套方案， Mysqlnd_ms 和 Mysql-Proxy。两个方案各有优／缺点</p>
<p><strong>Mysqlnd_ms</strong></p>
<p>优点：</p>
<pre><code><span class="bullet">1. </span>PHP官方推荐的扩展，PECL安装方便
</code></pre><ol>
<li>基于PHP扩展对SQL进行解析，进而分离请求，对业务层代码改动小，性能损失也小</li>
<li>扩展本身已经在社区打滚有些年头了，较稳定，口碑好</li>
<li>入门级文档清晰，易配置易上手</li>
<li>有连接池</li>
<li><p>功能强大，支持SQL Hint， 事务，最终／Session/强一致性等场景</p>
<p>缺点：</p>
<ol>
<li>基于扩展的封装，扩展的实现对上层透明。扩展本身缺乏debug工具， 所以真遇到问题可能比较难查</li>
</ol>
</li>
<li>Failover 策略较基础</li>
<li>缺乏中文文档</li>
<li><p>强一致性的场景会有些坑</p>
<p><strong>Mysql-Proxy</strong></p>
<p>优点:</p>
<ol>
<li>来自Mysql官方的解决方案</li>
</ol>
</li>
<li>性能好，资源占用少</li>
<li>有连接池</li>
<li>配置简单／文档众多</li>
<li><p>应有广泛，口碑好</p>
<p>缺点:</p>
<ol>
<li>需要第三方脚本(Lua)支持</li>
</ol>
</li>
</ol>
<p>鉴于”对业务层代码改动要小”这个需求，以及笔者对Mysql-Proxy 使用较少，所以在简单比较之后，果断选择了Mysqlnd_ms。</p>
<h1 id="安装">安装</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>wget http://pecl.php.net/get/mysqlnd_ms-1.5.2.tgz </span><br><span class="line"><span class="bullet">2. </span>tar xzvf mysqlnd_ms-1.5.2.tgz</span><br><span class="line"><span class="bullet">3. </span>cd mysqlnd_ms-1.5.2</span><br><span class="line"><span class="bullet">4. </span>/path/to/phpize</span><br><span class="line"><span class="bullet">5. </span>./configure --enable-mysqlnd-ms --with-php-config=/usr/local/php/bin/php-config</span><br><span class="line"><span class="bullet">6. </span>make</span><br><span class="line"><span class="bullet">7. </span>make install</span><br><span class="line"><span class="bullet">8. </span>sudo /etc/init.d/php-fpm restart</span><br><span class="line"><span class="bullet">9. </span>/path/to/php -m | grep mysql #看到"mysqlnd_ms"扩展表示安装成功</span><br></pre></td></tr></table></figure>
<h1 id="配置">配置</h1><h2 id="1-_创建配置文件_/usr/local/etc/php/php-d/mysqlnd_ms-ini">1. 创建配置文件 /usr/local/etc/php/php.d/mysqlnd_ms.ini</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">extension=</span><span class="string">"/usr/local/php-5.5.9/lib/php/extensions/no-debug-non-zts-20121212/mysqlnd_ms.so"</span> </span><br><span class="line">; 启动mysqlnd_ms</span><br><span class="line">mysqlnd_ms.<span class="variable">enable=</span><span class="number">1</span></span><br><span class="line">; 加载的主从配置文件</span><br><span class="line">mysqlnd_ms.<span class="variable">config_file=</span><span class="string">"/usr/local/etc/php/php.d/mysqlnd_ms.conf"</span> </span><br><span class="line">; 是否禁用读写分离</span><br><span class="line">mysqlnd_ms.<span class="variable">disable_rw_split=</span><span class="number">0</span></span><br><span class="line">; mysqlnd 日志输出格式(线上环境可选)</span><br><span class="line">mysqlnd.<span class="variable">debug=</span><span class="string">"d:t:x:A,/tmp/mysqlnd.trace"</span> </span><br><span class="line">;<span class="variable">SERVER_QUERY_NO_GOOD_INDEX_USED=</span><span class="number">16</span></span><br><span class="line">;<span class="variable">SERVER_QUERY_NO_INDEX_USED=</span><span class="number">32</span></span><br><span class="line">;<span class="variable">SERVER_QUERY_WAS_SLOW=</span><span class="number">1024</span></span><br><span class="line">; 日志掩码</span><br><span class="line">mysqlnd.<span class="variable">log_mask=</span><span class="number">1072</span></span><br><span class="line"></span><br><span class="line">; 网络读缓存大小</span><br><span class="line">; <span class="number">64</span>K</span><br><span class="line">mysqlnd.<span class="variable">net_read_buffer_size=</span><span class="number">65536</span></span><br><span class="line">; 网络读等待时间</span><br><span class="line">mysqlnd.<span class="variable">net_read_timeout=</span><span class="number">600</span></span><br></pre></td></tr></table></figure>
<h2 id="2-_创建主从策略文件_/usr/local/etc/php/php-d/mysqlnd_ms-conf_(位置由mysqlnd_ms-ini指定)">2. 创建主从策略文件 /usr/local/etc/php/php.d/mysqlnd_ms.conf (位置由mysqlnd_ms.ini指定)</h2><p>Demo 主从写成了同一个库<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;</span><br><span class="line">    <span class="string">"master-slave"</span>: <span class="collection">&#123; // section 对应一组服务</span><br><span class="line">        <span class="string">"master"</span>: <span class="collection">&#123; // 主库配置<span class="list">(默认主库只包含一项)</span></span><br><span class="line">            <span class="string">"master_0"</span>: <span class="collection">&#123;</span><br><span class="line">                <span class="string">"host"</span>: <span class="string">"192.168.100.100"</span>,//host必选 其他可为空。 扩展优先使用本文件中的配置，如果为空，再去使用php连接mysql时使用的参数</span><br><span class="line">                <span class="string">"port"</span>: <span class="string">"3306"</span>,</span><br><span class="line">                <span class="string">"socket"</span>: <span class="string">"\/var\/data\/mysql\/mysql.sock"</span>,</span><br><span class="line">                <span class="string">"db"</span>: <span class="string">"master-slave"</span>,</span><br><span class="line">                <span class="string">"user"</span>: <span class="string">"root"</span>,</span><br><span class="line">                <span class="string">"password"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"connect_flags"</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span></span><br><span class="line">        &#125;</span>,</span><br><span class="line">        <span class="string">"slave"</span>: <span class="collection">&#123; // 从库配置<span class="list">(可配置多项，slave为空会在php处报warning)</span></span><br><span class="line">            <span class="string">"slave_0"</span>: <span class="collection">&#123;</span><br><span class="line">                <span class="string">"host"</span>: <span class="string">"192.168.100.101"</span>,</span><br><span class="line">                <span class="string">"port"</span>: <span class="string">"3306"</span>,</span><br><span class="line">                <span class="string">"socket"</span>: <span class="string">"\/var\/data\/mysql\/mysql.sock"</span>,</span><br><span class="line">                <span class="string">"db"</span>: <span class="string">"master-slave"</span>,</span><br><span class="line">                <span class="string">"user"</span>: <span class="string">"root"</span>,</span><br><span class="line">                <span class="string">"password"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"connect_flags"</span>: <span class="number">0</span>                                                                   </span><br><span class="line">            &#125;</span>,</span><br><span class="line">            <span class="string">"slave_1"</span>: <span class="collection">&#123;</span><br><span class="line">                <span class="string">"host"</span>: <span class="string">"192.168.100.102"</span>,</span><br><span class="line">                <span class="string">"port"</span>: <span class="string">"3306"</span>,</span><br><span class="line">                <span class="string">"socket"</span>: <span class="string">"\/var\/data\/mysql\/mysql.sock"</span>,</span><br><span class="line">                <span class="string">"db"</span>: <span class="string">"master-slave"</span>,</span><br><span class="line">                <span class="string">"user"</span>: <span class="string">"root"</span>,</span><br><span class="line">                <span class="string">"password"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"connect_flags"</span>: <span class="number">0</span>                        </span><br><span class="line">            &#125;</span>,</span><br><span class="line">        &#125;</span>,   </span><br><span class="line">        <span class="string">"lazy_connections"</span>: <span class="number">1</span>, //只在执行sql之前才连接数据库</span><br><span class="line">        <span class="string">"server_charset"</span> : <span class="string">"utf8"</span> //服务端编码</span><br><span class="line">    &#125;</span>   </span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>/etc/init.d/php-fpm restart  #重启fpm生效</p>
<h2 id="3-_一些基本的参数说明">3. 一些基本的参数说明</h2><table>
<thead>
<tr>
<th style="text-align:left">参数名称</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">master</td>
<td style="text-align:left">主库配置</td>
</tr>
<tr>
<td style="text-align:left">host</td>
<td style="text-align:left">ip or hostname</td>
</tr>
<tr>
<td style="text-align:left">port</td>
<td style="text-align:left">端口</td>
</tr>
<tr>
<td style="text-align:left">socket</td>
<td style="text-align:left">连接套接字</td>
</tr>
<tr>
<td style="text-align:left">db</td>
<td style="text-align:left">库名字</td>
</tr>
<tr>
<td style="text-align:left">user</td>
<td style="text-align:left">用户名</td>
</tr>
<tr>
<td style="text-align:left">password</td>
<td style="text-align:left">用户密码</td>
</tr>
<tr>
<td style="text-align:left">connect_flags</td>
<td style="text-align:left">连接参数</td>
</tr>
<tr>
<td style="text-align:left">slave</td>
<td style="text-align:left">从库配置</td>
</tr>
<tr>
<td style="text-align:left">global_transaction_id_injection</td>
<td style="text-align:left">GTID的配置 详见 <a href="http://cn2.php.net/manual/zh/mysqlnd-ms.plugin-ini-json.php" target="_blank" rel="external">http://cn2.php.net/manual/zh/mysqlnd-ms.plugin-ini-json.php</a></td>
</tr>
<tr>
<td style="text-align:left">filter</td>
<td style="text-align:left">选择从库的策略 random/roundrobin/user/user_multi/node_groups 策略详情详见 <a href="http://cn2.php.net/manual/zh/mysqlnd-ms.plugin-ini-json.php" target="_blank" rel="external">http://cn2.php.net/manual/zh/mysqlnd-ms.plugin-ini-json.php</a></td>
</tr>
<tr>
<td style="text-align:left">failover</td>
<td style="text-align:left">故障转移 disabled (默认), master(读从失败就连主库),loop_before_master(读从失败轮寻其他从库再读主库)</td>
</tr>
<tr>
<td style="text-align:left">lazy_connections</td>
<td style="text-align:left">被动连接</td>
</tr>
<tr>
<td style="text-align:left">server_charset</td>
<td style="text-align:left">服务端字符集</td>
</tr>
<tr>
<td style="text-align:left">trx_stickiness</td>
<td style="text-align:left">事务控制策略</td>
</tr>
</tbody>
</table>
<h1 id="使用">使用</h1><ol>
<li><p>通常情况下，使用mysqlnd_ms 不需要改动业务端的代码，只需要在连接数据库时，使用配置中的host，即可实现主从分离，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$dbh</span>  = <span class="keyword">new</span>  PDO ( <span class="string">'mysql:host=master-slave;dbname=master-slave'</span> ,  <span class="string">'root'</span> ,  <span class="string">''</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Master */</span></span><br><span class="line">    <span class="keyword">foreach</span>( <span class="variable">$dbh</span> -&gt; query ( <span class="string">'show tables'</span> ) <span class="keyword">as</span>  <span class="variable">$row</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        print_r ( <span class="variable">$row</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Slave */</span></span><br><span class="line">    <span class="keyword">foreach</span>( <span class="variable">$dbh</span> -&gt; query ( <span class="string">'SELECT * from test LIMIT 1'</span> ) <span class="keyword">as</span>  <span class="variable">$row</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        print_r ( <span class="variable">$row</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$dbh</span>  =  <span class="keyword">null</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> ( PDOException <span class="variable">$e</span> )</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">print</span>  <span class="string">"Error!: "</span>  .  <span class="variable">$e</span> -&gt; getMessage () .  <span class="string">"&lt;br/&gt;"</span> ;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="keyword">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump(<span class="variable">$e</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>采取主从分离，就一定存在着同步延迟的问题。 在一个繁忙的服务中，主／从同步会存在延迟。mysqlnd_ms 将这种场景细分为：</p>
</li>
</ol>
<ul>
<li>最终一致性：用户可能无法立即看到自己写入的数据</li>
<li>session一致性：用户自己可以立即看到自己写入的数据</li>
<li>强一致性：所有的用户都可以立即看到其他用户的写入的数据</li>
</ul>
<p>mysqlnd_ms 针对不同的场景，提供不同的策略。如果对延迟比较敏感(如：用户提交表单后，页面立即跳转展示用户提交的数据)，在编码的过程中还需要参考下述文档</p>
<ol>
<li>SQL Hints: <a href="http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.sqlhints.php" target="_blank" rel="external">http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.sqlhints.php</a></li>
<li>事务： <a href="http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.transactions.php" target="_blank" rel="external">http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.transactions.php</a></li>
<li>服务级别和一致性： <a href="http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.qos-consistency.php" target="_blank" rel="external">http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.qos-consistency.php</a></li>
<li>Global transaction IDs (GTID)： <a href="http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.gtid.php" target="_blank" rel="external">http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.gtid.php</a></li>
<li>Cache integration： <a href="http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.cache.php" target="_blank" rel="external">http://cn2.php.net/manual/zh/mysqlnd-ms.quickstart.cache.php</a></li>
</ol>
<h1 id="一些陷阱">一些陷阱</h1><ol>
<li>Mysqlnd_ms 的行为是这样的。 所有的Select 操作会访问从库， 除Select 其他的所有操作都访问主库，包括(SHOW, SET等)。<br>所以习惯使用mysql变量来编程的同学要注意了，如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">set</span> @id=<span class="number">2</span>;</span>(主库)</span><br><span class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> id:=@id（从库）;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>上面的第二条语句会因为在从库找不到id这个变量而报错， 这种情况要SQL Hint 给Mysql一些提示</p>
<ol>
<li>Mysqlnd_ms 并不支持 <em>mysqli</em> 的multi_statements。 如使用mysqli_multi_query() 来批量执行SQL<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">"SELECT * FROM &#123;$table&#125; WHERE .."</span>;</span><br><span class="line"><span class="variable">$sql</span> .= <span class="string">"INSERT INTO &#123;$table&#125;"</span>;</span><br><span class="line"><span class="variable">$mysqli</span> -&gt; multi_query (<span class="variable">$sql</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>上面的第一条SQL会被识别为访问从库，Mysqlnd_ms 无法拆分一个批量操作，所以第二条Insert 也会进从库而造成数据不一致。</p>
<ol>
<li>事务的默认行为也和上述第二点一样，无法拆分一个事务，所以”读／写”请求尽量不要写进同一个事务中。如果一定要写，要使用SQL Hint 给Mysqlnd_ms 一些提示。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.harrycode.com/2014/05/10/installation-configuration-and-use-of-mysqlnd-ms/" data-id="ci9txs1ye000pecs61swfsoso" class="article-share-link">分享到</a>
      

      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-simple-steps-to-build-cool-vim-development-environment" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/05/simple-steps-to-build-cool-vim-development-environment/" class="article-date">
  <time datetime="2014-05-05T04:05:00.000Z" itemprop="datePublished">2014-05-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/05/05/simple-steps-to-build-cool-vim-development-environment/">简单几步搭建超酷的Vim开发环境</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>无论是在前公司还是在新公司，总有同事路过我的工位，对着我的Vim界面赞叹不已，然后述说自己当年下好大决心工作在Vim环境中，后来“创业未半而中道崩殂”的苦楚… -_-# 后来我发现这些人多半不是卡在Vim的基本操作，而是抱怨Vim不能满足他们的各种开发需求，也没时间去了解或配置一些常规插件。望着一些其他的IDE内置了自己梦寐以求的功能，最终缴械投降。</p>
<p>本着践行／传播Vim这一利器的主旨，把自己搭建Vim开发环境的一些经验分享出来。其实类似的文章已经很多了，其中不乏非常专业的文章。但是其实”懒人”真正需要的是一个可以”Setup-&gt;Next-&gt;Next-&gt;Finish”，然后”哇～ Amazing！！”的Vim集成开发环境。我们就来看看，如何通过简单几步，让您拥有一个超Cool并且可以到处炫耀的Vim环境～ :)</p>
<p>现在我们要祭出一件神器，也是本文中要着重介绍的一款软件 —— spf13-vim (<a href="https://github.com/spf13/spf13-vim" target="_blank" rel="external">https://github.com/spf13/spf13-vim</a>)。 这东西是一个Vim的集成开发环境，内置集成很多码农们常用的插件，基于bundle的方式非常方便扩展以及更新，是初学者们了解Vim以及精通Vim的一个很好的出发点，极大的降低了Vim使用的门槛。</p>
<h1 id="安装_spf13-vim">安装 spf13-vim</h1><h2 id="官方的安装步骤">官方的安装步骤</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http<span class="variable">s:</span>//<span class="keyword">j</span>.mp/spf13-vim3 -L &gt; spf13-<span class="keyword">vim</span>.<span class="keyword">sh</span> &amp;&amp; <span class="keyword">sh</span> spf13-<span class="keyword">vim</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p>官方的安装步骤很简便，但是综合了我国GFW的国情后，稍显得有些问题。官方的安装脚本会自动执行Vundle安装内置的插件，Vundle会自动Clone GitHub上的这些扩展，但是在我国从Github上clone代码还是很慢的，默认安装的插件也比较多，整个安装过程就比较慢。另外有些默认插件可能是你不需要的，都安装了用不上，费电不说，其实拖慢Vim的执行速度。下面我们看看怎样做一些设置。</p>
<h2 id="自定义的安装步骤">自定义的安装步骤</h2><p>首先我们只下载安装脚本，但不要默认执行<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http<span class="variable">s:</span>//<span class="keyword">j</span>.mp/spf13-vim3 -L &gt; spf13-<span class="keyword">vim</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure></p>
<p>编辑spf13-vim.sh, 可以在最后看到这样一行, 看setup_vundle的函数定义，知道这个函数就是执行vundle 安装插件的命令，我们用 <code>&quot;</code> 注释掉这一行， 然后给脚本执行权限并执行spf安装脚本。chmod u+x spf13-vim.sh ＆＆ sh spf13-vim.sh<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">" setup_vundle    "</span>Now updating/installing plugins using Vundle<span class="string">"</span></span><br></pre></td></tr></table></figure></p>
<p>很快我们看到spf13安装完成了，在home目录下执行 ls -lha | grep vim  可以看到spf13安装的vim配置文件的软链接<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lrwxrwxrwx   <span class="number">1</span> harry harry   <span class="number">33</span> May  <span class="number">5</span> <span class="number">11</span>:<span class="number">27</span> <span class="class">.vimrc</span> -&gt; /home/tianhai/.spf13-vim-<span class="number">3</span>/<span class="class">.vimrc</span></span><br><span class="line">lrwxrwxrwx   <span class="number">1</span> harry harry   <span class="number">40</span> May  <span class="number">5</span> <span class="number">11</span>:<span class="number">27</span> <span class="class">.vimrc</span><span class="class">.before</span> -&gt; /home/tianhai/.spf13-vim-<span class="number">3</span>/<span class="class">.vimrc</span><span class="class">.before</span></span><br><span class="line">-rw-r--r--   <span class="number">1</span> harry harry  <span class="number">143</span> May  <span class="number">5</span> <span class="number">11</span>:<span class="number">45</span> <span class="class">.vimrc</span><span class="class">.before</span><span class="class">.local</span></span><br><span class="line">lrwxrwxrwx   <span class="number">1</span> harry harry   <span class="number">41</span> May  <span class="number">5</span> <span class="number">11</span>:<span class="number">27</span> <span class="class">.vimrc</span><span class="class">.bundles</span> -&gt; /home/tianhai/.spf13-vim-<span class="number">3</span>/<span class="class">.vimrc</span><span class="class">.bundles</span></span><br><span class="line">lrwxrwxrwx   <span class="number">1</span> harry harry   <span class="number">31</span> May  <span class="number">5</span> <span class="number">11</span>:<span class="number">27</span> <span class="class">.vim</span> -&gt; /home/tianhai/.spf13-vim-<span class="number">3</span>/.vim</span><br></pre></td></tr></table></figure></p>
<p>编辑 .vimrc.bundles 这个文件,可以看到类似的代码块， 这个代码块就是告诉Vundle来安装哪些扩展<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">" Misc &#123;</span><br><span class="line"></span>    <span class="keyword">if</span> <span class="built_in">count</span>(<span class="variable">g:spf13_bundle_groups</span>, <span class="string">'misc'</span>)</span><br><span class="line">        Bundle <span class="string">'tpope/vim-markdown'</span></span><br><span class="line">        Bundle <span class="string">'spf13/vim-preview'</span></span><br><span class="line">        Bundle <span class="string">'tpope/vim-cucumber'</span></span><br><span class="line">        Bundle <span class="string">'quentindecock/vim-cucumber-align-pipes'</span></span><br><span class="line">        Bundle <span class="string">'Puppet-Syntax-Highlighting'</span></span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">" &#125;</span><br></pre></td></tr></table></figure></p>
<p>回到 100行左右， 可以看到如下的配置<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">" In your .vimrc.before.local file</span><br><span class="line"></span><span class="string">" list only the plugin groups you will use</span><br><span class="line"></span><span class="keyword">if</span> !exists(<span class="string">'g:spf13_bundle_groups'</span>)</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">g:spf13_bundle_groups</span>=[<span class="string">'general'</span>, <span class="string">'writing'</span>, <span class="string">'neocomplcache'</span>, <span class="string">'programming'</span>, <span class="string">'php'</span>, <span class="string">'ruby'</span>, <span class="string">'python'</span>, <span class="string">'twig'</span>, <span class="string">'javascript'</span>, <span class="string">'html'</span>, <span class="string">'misc'</span>,]</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure></p>
<p>spf13_bundle_groups 这个变量用来控制Vundle加载那些模块，spf默认安装了一些php/ruby/python／html/js的扩展，就像注释中说的，我们可以通过覆盖这个变量来自定义Vundle加载的扩展。譬如我想安装go 但我的工作中不使用twig，我就可以在.vimrc.before.local 通过覆盖 spf13_bundle_groups 变量的方式来做自定义。下面是我的定义：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">echo</span> "<span class="tag">let</span> <span class="rule"><span class="attribute">g</span>:<span class="value">spf13_bundle_groups=[<span class="string">'general'</span>, <span class="string">'writing'</span>, <span class="string">'neocomplcache'</span>, <span class="string">'programming'</span>, <span class="string">'php'</span>, <span class="string">'ruby'</span>, <span class="string">'python'</span>, <span class="string">'javascript'</span>, <span class="string">'go'</span>, <span class="string">'html'</span>, <span class="string">'misc'</span>,]<span class="string">" &gt;&gt; .vimrc.before.local</span></span></span></span><br></pre></td></tr></table></figure>
<p>之后我们执行来激活Vundle开始安装扩展，其实使用vim打开任意文件，执行<code>:PluginInstall</code>也是一样的，看个人喜好<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="string">\</span></span><br><span class="line">    -u <span class="string">"$HOME/.vimrc.bundles"</span> <span class="string">\</span></span><br><span class="line">    <span class="string">"+set nomore"</span> <span class="string">\</span></span><br><span class="line">    +BundleInstall! <span class="string">\</span></span><br><span class="line">    +BundleClean <span class="string">\</span></span><br><span class="line">    +qall</span><br></pre></td></tr></table></figure></p>
<p>执行后我们能看到Vundle开始安装扩展，综合了GFW的国情后，其实还是不快，给点耐心吧～ :)</p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/197145/vQ2OrN4uTtiIl6MWKMvJ_2014-05-05%2013:31:04%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" alt="Vundle Install"></p>
<p>安装完成后，恭喜你，你已经拥有了一个功能强大的Vim集成开发环境了。</p>
<h1 id="Vundle">Vundle</h1><p>spf13 默认使用 Vundle (<a href="https://github.com/gmarik/Vundle.vim" target="_blank" rel="external">https://github.com/gmarik/Vundle.vim</a>)来管理vim插件</p>
<p>关于Vundle的使用，可以参考这篇博客 <a href="http://foocoder.com/blog/mei-ri-vimcha-jian-kai-pian-zhi-vundle.html" target="_blank" rel="external">每日vim插件—开篇之vundle</a>，介绍的很详细。PS:博主每日都会介绍一款vim插件，vim功底深厚，讲的也很详细，建议大家follow。</p>
<p>回到spf13中， 我们可以通过扩展 ~/.vimrc.bundles.local 来追加一些我们偏爱但是spf13没有内置的插件，语法参考~/.vimrc.bundles 或者参考上面的博客。</p>
<h1 id="一些插件">一些插件</h1><h2 id="关于配色">关于配色</h2><p>spf13默认的配色方案是 solarized， 如果需要选择其他的配色方案，可以通过下面的命令来定义<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> colorscheme &#123;<span class="variable">$colorscheme</span>&#125;  &gt;&gt; ~/.vimrc.local</span><br></pre></td></tr></table></figure></p>
<p>spf13 内置了  vim-colors-solarized (<a href="https://github.com/altercation/vim-colors-solarized" target="_blank" rel="external">https://github.com/altercation/vim-colors-solarized</a>) 以及 vim-colors (<a href="https://github.com/spf13/vim-colors/" target="_blank" rel="external">https://github.com/spf13/vim-colors/</a>) 两个配色插件，集中了上百种配色，可以从中选择. 放置在  ~/.vim/bundle/vim-colors/ 以及 ~/.vim/bundle/vim-colorschemes/ 两个目录中。</p>
<p>我个人比较偏爱 molokai / peaksea / 256-jungle, 其中molokai在GVim下展示最好，256-jungle在终端下展示最好。</p>
<h2 id="关于字体">关于字体</h2><p>我个人偏爱  Source-Code-Pro   <a href="Source-Code-Pro   https://github.com/adobe/source-code-pro">https://github.com/adobe/source-code-pro</a></p>
<p>安装方法可以参考：<a href="https://github.com/adobe/source-code-pro/issues/17#issuecomment-8967116" target="_blank" rel="external">https://github.com/adobe/source-code-pro/issues/17#issuecomment-8967116</a></p>
<h2 id="BufExplore">BufExplore</h2><p><a href="https://github.com/vim-scripts/bufexplorer.zip" target="_blank" rel="external">https://github.com/vim-scripts/bufexplorer.zip</a><br><code>:BufExplorer</code> 列出已经打开的文件, 选择后跳转 </p>
<p><img src="http://user-image.logdown.io/user/1417/blog/1391/post/197145/EQahWRUvQAGIwf3lc3c7_bufexplore.png" alt="bufexplore.png"></p>
<h2 id="vim-indent-guides">vim-indent-guides</h2><p><a href="https://github.com/nathanaelkane/vim-indent-guides" target="_blank" rel="external">https://github.com/nathanaelkane/vim-indent-guides</a><br>用来优化展示缩进， 在GVim 中这个插件展示的很完美，可以自动识别背景色来展示。但是在终端环境中，只能显示dark/light两种模式，缩进看起来一块一块的，比较难看，我习惯默认关闭它。<br>在.vimrc.local 中添加 <code>let g:indent_guides_auto_colors = 0</code>. 我们可以通过<code>&lt;Leader&gt;ig</code>来开启它, spf13的默认<leader>键为 <code>,</code>。</leader></p>
<h2 id="NERDTree">NERDTree</h2><p><a href="https://github.com/scrooloose/nerdtree" target="_blank" rel="external">https://github.com/scrooloose/nerdtree</a></p>
<p>Vim的文件浏览器。 通过<code>:NERDTreeToggle</code> 来唤出，我习惯把它绑定到F5上，下面是我的配置<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let <span class="constant">NERDTreeChDirMode </span>= <span class="number">2</span></span><br><span class="line">let <span class="constant">NERDTreeWinSize </span>= <span class="number">30</span></span><br><span class="line">nmap &lt;<span class="constant">F5&gt;</span>  <span class="symbol">:NERDTreeToggle&lt;CR&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="ctrlp">ctrlp</h2><p><a href="https://github.com/kien/ctrlp.vim" target="_blank" rel="external">https://github.com/kien/ctrlp.vim</a></p>
<p>Vim中的文件查找器，类似sublime的ctrl-p，几个常用命令<br><code>：CtrlP</code> or <code>:CtrlP [starting-directory]</code>  启动ctrlp<br><code>:CtrlPBuffer</code> or <code>:CtrlPMRU</code> 启动ctrlp并只在buffer/mru中进行查找<br><code>:CtrlPMixed</code> 在 Files, Buffers 和 MRU 中进行混合查找</p>
<p>在ctrlp开启后，还有一些快捷键<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Press &lt;F5&gt; <span class="keyword">to</span> purge the cache <span class="keyword">for</span> the current directory <span class="keyword">to</span> get <span class="keyword">new</span> files, remove deleted files <span class="keyword">and</span> apply <span class="keyword">new</span> ignore options.</span><br><span class="line">Press &lt;c-f&gt; <span class="keyword">and</span> &lt;c-b&gt; <span class="keyword">to</span> cycle between modes.</span><br><span class="line">Press &lt;c-d&gt; <span class="keyword">to</span> switch <span class="keyword">to</span> filename only search instead <span class="keyword">of</span> full path.</span><br><span class="line">Press &lt;c-r&gt; <span class="keyword">to</span> switch <span class="keyword">to</span> regexp mode.</span><br><span class="line"><span class="keyword">Use</span> &lt;c-j&gt;, &lt;c-k&gt; <span class="keyword">or</span> the arrow keys <span class="keyword">to</span> navigate the result list.</span><br><span class="line"><span class="keyword">Use</span> &lt;c-t&gt; <span class="keyword">or</span> &lt;c-v&gt;, &lt;c-x&gt; <span class="keyword">to</span> <span class="keyword">open</span> the selected entry <span class="keyword">in</span> a <span class="keyword">new</span> tab <span class="keyword">or</span> <span class="keyword">in</span> a <span class="keyword">new</span> split.</span><br><span class="line"><span class="keyword">Use</span> &lt;c-n&gt;, &lt;c-p&gt; <span class="keyword">to</span> <span class="keyword">select</span> the <span class="keyword">next</span>/previous <span class="typename">string</span> <span class="keyword">in</span> the prompt<span class="attribute">'s</span> history.</span><br><span class="line"><span class="keyword">Use</span> &lt;c-y&gt; <span class="keyword">to</span> create a <span class="keyword">new</span> <span class="keyword">file</span> <span class="keyword">and</span> its parent directories.</span><br><span class="line"><span class="keyword">Use</span> &lt;c-z&gt; <span class="keyword">to</span> mark/unmark multiple files <span class="keyword">and</span> &lt;c-o&gt; <span class="keyword">to</span> <span class="keyword">open</span> them.</span><br></pre></td></tr></table></figure></p>
<h2 id="surround">surround</h2><p><a href="https://github.com/tpope/vim-surround" target="_blank" rel="external">https://github.com/tpope/vim-surround</a><br>用来处理包围符号的插件，包括’ “ { } [ ]等<br>下面是一些基本的用法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">**cs: 包围符号替换**</span><br><span class="line"><span class="string">'hello'</span> =&gt; cs<span class="string">'" =&gt;"hello"</span><br><span class="line">'</span>hello<span class="string">' =&gt; cs'</span>&lt;q&gt; =&gt;&lt;q&gt;hello&lt;/q&gt;</span><br><span class="line">&lt;q&gt;hello&lt;/q&gt; =&gt; cst<span class="string">' =&gt; '</span>hello<span class="string">'</span><br><span class="line">**ds: 去掉包围符号**</span><br><span class="line">'</span>hello<span class="string">' =&gt; ds'</span> =&gt; hello</span><br><span class="line">**ys: 添加包围符号**</span><br><span class="line">hello =&gt; ysiw<span class="string">' =&gt; '</span>hello<span class="string">'</span><br><span class="line">**yss: 整行添加包围符号**</span><br><span class="line">**yS/ySS 单独一行并有缩进**</span></span><br></pre></td></tr></table></figure></p>
<h2 id="nerdcommenter">nerdcommenter</h2><p><a href="https://github.com/scrooloose/nerdcommenter" target="_blank" rel="external">https://github.com/scrooloose/nerdcommenter</a></p>
<p>一个有用的注释插件。<br><code>&lt;Leader&gt;cc</code> 注释一行<br><code>&lt;Leader&gt;cu</code> 取消注释一行<br><code>&lt;Leader&gt;ca</code> 切换注释模式 ／／ 或 /**／<br><code>&lt;Leader&gt;cm</code> 以block的最简方式注释一段代码<br><code>&lt;Leader&gt;ci</code> 以独立注释单行的方式 注释选中的每一行， 注释模式取决<code>&lt;Leader&gt;ca</code><br><code>&lt;Leader&gt;cs</code> 以block的常规方式注释一段代码<br><code>&lt;Leader&gt;cA</code> 在行尾巴追加注释，注释模式取决于<code>&lt;Leader&gt;ca</code></p>
<h2 id="关于补全">关于补全</h2><p>spf13 提供了4种补全插件供我们选择(只能选择其中之一)</p>
<p>neocomplcache <a href="https://github.com/shougo/neocomplcache" target="_blank" rel="external">https://github.com/shougo/neocomplcache</a><br>YouCompleteMe <a href="https://github.com/Valloric/YouCompleteMe" target="_blank" rel="external">https://github.com/Valloric/YouCompleteMe</a><br>neocomplete  <a href="https://github.com/Shougo/neocomplete.vim" target="_blank" rel="external">https://github.com/Shougo/neocomplete.vim</a></p>
<p>关于这几个补全插件的优劣，在各大论坛争论已久，neocomplete的作者在github上给出了一些自己看法，我觉得很值得参考<br><a href="https://github.com/skwp/dotfiles/issues/330#issuecomment-19034756" target="_blank" rel="external"> https://github.com/skwp/dotfiles/issues/330#issuecomment-19034756 </a></p>
<p>我目前在用neocomplcache， 稍稍有些转到neocomplete的倾向了～ :)</p>
<h2 id="PIV">PIV</h2><p><a href="https://github.com/spf13/PIV" target="_blank" rel="external">https://github.com/spf13/PIV</a></p>
<p>我大PHP的开发插件，可以方便的对function/class/variable 生成注释<code>&lt;Leader&gt;pd</code>, 在任意php内建函数上操作<code>&lt;Shift-k&gt;</code>，可以查看该函数的manual</p>
<h2 id="tabular">tabular</h2><p><a href="https://github.com/godlygeek/tabular" target="_blank" rel="external">https://github.com/godlygeek/tabular</a></p>
<p>对齐控们的福音,可以对 = : , 做对齐操作</p>
<p><code>&lt;Leader&gt;a=</code>  对<code>=</code>进行对齐操作<br><code>&lt;Leader&gt;a:</code>  对<code>:</code>进行对齐操作<br><code>&lt;Leader&gt;a::</code> 对<code>:</code> 后面的内容做对其操作，而<code>:</code>靠前紧贴<br><code>&lt;Leader&gt;a,</code>  对<code>,</code>进行对齐操作</p>
<h2 id="tagbar">tagbar</h2><p><a href="https://github.com/majutsushi/tagbar" target="_blank" rel="external">https://github.com/majutsushi/tagbar</a></p>
<p>Vim的tag插件，能在一个窗口中显示当前文件的tag，需要安装ctag/exuberant-ctags。<br>PS: 这个插件只展示tag，并不会做func的自动跳转</p>
<p>我的常用配置<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;<span class="constant">F6&gt;</span> <span class="symbol">:TagbarToggle&lt;CR&gt;</span> <span class="string">"我一般把tagbar绑在&lt;F6&gt;上</span><br><span class="line">let g:tagbar_autoclose=1 "</span>在一个tag上按回车后，自动跳转到tag在文件的位置，并关闭tagbar</span><br></pre></td></tr></table></figure></p>
<h1 id="写在最后">写在最后</h1><p>说是”简单几步”，最后还是唠唠叨叨的这么多，主要是希望大家用的更舒服些，对VIM的恐惧更少一些，上面的插件主要参考了spf13中的一些介绍，加上了自己的一些理解，应该够大家用上一段时间了。其实Github上的vim插件很多，通过Vundle可以很方便的安装以及管理，有兴趣的同学可以找一些适合自己的，慢慢的你就会觉得VIM无所不能了～ :)</p>
<p>今天就到这里， Enjoy~</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.harrycode.com/2014/05/05/simple-steps-to-build-cool-vim-development-environment/" data-id="ci9txs1y5000aecs6vo8x13dl" class="article-share-link">分享到</a>
      

      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vim/">vim</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tool/">Tool</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tools/">Tools</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux/" style="font-size: 20px;">Linux</a><a href="/tags/Tool/" style="font-size: 10px;">Tool</a><a href="/tags/Tools/" style="font-size: 15px;">Tools</a><a href="/tags/git/" style="font-size: 10px;">git</a><a href="/tags/php/" style="font-size: 10px;">php</a><a href="/tags/vim/" style="font-size: 10px;">vim</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/12/03/2014-12-03-to-hadoop-working-mechanism/">[转]  Hadoop工作机制</a>
          </li>
        
          <li>
            <a href="/2014/12/03/to-understand-mapreduce-data-flow/">[转] 理解MapReduce数据流</a>
          </li>
        
          <li>
            <a href="/2014/12/03/to-briefly-introduce-each-major-module-of-hadoop/">[转] 简要介绍Hadoop的各个主要模块</a>
          </li>
        
          <li>
            <a href="/2014/12/03/to-to-quickly-grasp-mapreduce/">[转] 快速理解MapReduce</a>
          </li>
        
          <li>
            <a href="/2014/12/03/to-to-quickly-grasp-mapreduce-1/">[转] 快速理解MapReduce</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Harry<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->


<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true
                    
}
  
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
                  
}
    
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
            for(i=0; i < all.length; i += 1) {
                            all[i].SourceElement().parentNode.className += ' has-jax';
                                    
            }
                
        });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<script src="/js/script.js" type="text/javascript"></script>

</div>
</body>
</html>
